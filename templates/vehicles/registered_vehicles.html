{% extends "base.html" %}
{% load static %}

{% block title %}Registered Vehicles | RDFS{% endblock %}

{% block content %}

<style>
/* =====================================================
   RDFS – REGISTERED VEHICLES (SCOPED STYLES ONLY)
   Prefix: rdfs-vehicles-
===================================================== */
.rdfs-vehicles-scope{
  --rdfs-blue:#112666;
  --rdfs-blue-dark:#0c1c4a;
  --rdfs-accent:#2563eb;
  --rdfs-soft:#e8f4fd;

  --rdfs-text:#0f172a;
  --rdfs-muted:#64748b;

  --gray-100:#f7fafc;
  --gray-200:#edf2f7;
  --gray-300:#e2e8f0;

  --shadow-sm:0 1px 3px rgba(0,0,0,.08);
  --shadow-md:0 8px 18px rgba(0,0,0,.12);

  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
  color:var(--rdfs-text);
}

/* HEADER */
.rdfs-vehicles-title{
  font-weight:700;
  color:var(--rdfs-blue);
}

/* SEARCH */
.rdfs-vehicles-search{
  display:flex;
}

.rdfs-vehicles-search input{
  height:48px;
  border-radius:999px;
  border:1.5px solid var(--gray-300);
}

.rdfs-vehicles-search input:focus{
  border-color:var(--rdfs-accent);
  box-shadow:0 0 0 3px rgba(37,99,235,.18);
}

.rdfs-vehicles-search button{
  border-radius:999px;
  font-weight:700;
  background:linear-gradient(135deg,var(--rdfs-accent),var(--rdfs-blue));
  border:none;
  color:#fff;
}

/* CARD */
.rdfs-vehicles-card{
  border-radius:18px;
  box-shadow:var(--shadow-md);
  border:1px solid var(--gray-200);
}

/* TABLE */
.rdfs-vehicles-table thead{
  background:var(--gray-100);
}

.rdfs-vehicles-table th{
  color:var(--rdfs-blue-dark);
  font-weight:700;
  white-space:nowrap;
}

.rdfs-vehicles-table td{
  vertical-align:middle;
  font-size:.9rem;
}

/* ACTION BUTTONS */
.rdfs-vehicles-delete{
  border-radius:999px;
  font-weight:600;
}

.rdfs-vehicles-qr{
  border-radius:999px;
  font-weight:600;
}

/* PAGINATION */
.rdfs-vehicles-pagination .page-link{
  border-radius:999px;
  margin:0 2px;
  color:var(--rdfs-blue);
}

.rdfs-vehicles-pagination .active .page-link{
  background:var(--rdfs-blue);
  border-color:var(--rdfs-blue);
}
</style>

<div class="rdfs-vehicles-scope p-4">

  <h3 class="rdfs-vehicles-title mb-2">
    <i class="bi bi-truck-front-fill me-2"></i>
    Registered Vehicles
  </h3>
  <p class="text-muted mb-4">
    View, search, and manage registered vehicles in the system.
  </p>

  <!-- MESSAGES -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- SEARCH -->
  <form method="get"
        class="rdfs-vehicles-search mb-3"
        role="search"
        onsubmit="return false;">
    <input
      type="text"
      id="rdfsVehicleSearch"
      class="form-control me-2"
      placeholder="Search vehicle by driver, plate, type, or name..."
    />
    <button type="submit">
      <i class="bi bi-search-heart-fill me-1"></i>
      Search
    </button>
  </form>

  <!-- TABLE CARD -->
  <div class="card rdfs-vehicles-card">
    <div class="card-body table-responsive">

      {% if vehicles %}
      <table class="table table-bordered table-hover align-middle rdfs-vehicles-table"
             id="rdfsVehicleTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Driver</th>
            <th>Vehicle Name</th>
            <th>Type</th>
            <th>Plate</th>
            <th>CR No.</th>
            <th>OR No.</th>
            <th>VIN</th>
            <th>Year</th>
            <th>Expiry</th>
            <th>QR Code</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for vehicle in vehicles %}
          <tr>
            <td>{{ forloop.counter0|add:vehicles.start_index }}</td>
            <td>
              {% if vehicle.assigned_driver %}
                {{ vehicle.assigned_driver.first_name }}
                {{ vehicle.assigned_driver.last_name }}
              {% else %}
                <span class="text-muted">Unassigned</span>
              {% endif %}
            </td>
            <td>{{ vehicle.vehicle_name }}</td>
            <td>{{ vehicle.get_vehicle_type_display }}</td>
            <td>{{ vehicle.license_plate }}</td>
            <td>{{ vehicle.cr_number }}</td>
            <td>{{ vehicle.or_number }}</td>
            <td>{{ vehicle.vin_number }}</td>
            <td>{{ vehicle.year_model }}</td>
            <td>
              {% if vehicle.registration_expiry %}
                {{ vehicle.registration_expiry|date:"M d, Y" }}
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>
              {% if vehicle.qr_code %}
                <a href="{% url 'vehicles:vehicle_qr' vehicle.id %}"
                   class="btn btn-outline-secondary btn-sm rdfs-vehicles-qr"
                   target="_blank">
                  <i class="bi bi-printer-fill me-1"></i>
                  View / Print
                </a>
              {% else %}
                <span class="text-muted">No QR</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_superuser or user.role == 'admin' %}
                <button class="btn btn-danger btn-sm rdfs-vehicles-delete btn-delete-item"
                        data-url="{% url 'vehicles:delete_vehicle' vehicle.id %}"
                        data-type="Vehicle">
                  <i class="bi bi-trash-fill me-1"></i>
                  Delete
                </button>
              {% else %}
                <span class="text-muted">No Action</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="12" class="text-center text-muted py-3">
              No vehicles found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="text-center text-muted mb-0">
          No vehicles registered yet.
        </p>
      {% endif %}

    </div>
  </div>

  <!-- PAGINATION -->
  {% if vehicles.has_other_pages %}
  <nav class="rdfs-vehicles-pagination mt-3">
    <ul class="pagination justify-content-center">
      {% if vehicles.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ vehicles.previous_page_number }}">&laquo; Prev</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo; Prev</span></li>
      {% endif %}

      {% for i in vehicles.paginator.page_range %}
        {% if vehicles.number == i %}
          <li class="page-item active"><span class="page-link">{{ i }}</span></li>
        {% else %}
          <li class="page-item">
            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
          </li>
        {% endif %}
      {% endfor %}

      {% if vehicles.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ vehicles.next_page_number }}">Next &raquo;</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next &raquo;</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  <!-- BACK -->
  <div class="mt-4 text-end">
    <a href="{% url 'accounts:staff_dashboard' %}"
       class="btn btn-secondary btn-lg">
      <i class="bi bi-arrow-left-circle-fill me-1"></i>
      Back to Dashboard
    </a>
  </div>

</div>

<!-- SEARCH FILTER + DELETE SCRIPT -->
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded",function(){

  /* SEARCH FILTER */
  $('#rdfsVehicleSearch').on('keyup',function(){
    const value=$(this).val().toLowerCase();
    $('#rdfsVehicleTable tbody tr').filter(function(){
      $(this).toggle($(this).text().toLowerCase().indexOf(value)>-1);
    });
  });

  /* DELETE HANDLER */
  document.querySelectorAll('.btn-delete-item').forEach(btn=>{
    btn.addEventListener('click',function(){
      const url=this.dataset.url;
      const type=this.dataset.type||'Item';
      if(confirm(`Are you sure you want to delete this ${type}?`)){
        fetch(url,{
          method:'POST',
          headers:{'X-CSRFToken':'{{ csrf_token }}'}
        })
        .then(r=>r.json())
        .then(d=>{
          if(d.success){
            alert(`${type} deleted successfully.`);
            location.reload();
          }else{
            alert(`❌ Failed to delete ${type}`);
          }
        })
        .catch(()=>alert(`❌ Error deleting ${type}`));
      }
    });
  });

});
</script>

{% endblock %}
