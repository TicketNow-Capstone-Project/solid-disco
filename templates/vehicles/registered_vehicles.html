{% extends "base.html" %}
{% load static %}

{% block title %}Registered Vehicles | TicketNow{% endblock %}

{% block content %}
<div class="p-4">
  <h3 class="mb-3"><i class="bi bi-list-ul"></i> Registered Vehicles</h3>
  <p class="text-muted">View, search, and manage registered vehicles in the system.</p>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Search Bar -->
  <div class="input-group mb-3 shadow-sm">
    <span class="input-group-text bg-primary text-white">
      <i class="bi bi-search"></i>
    </span>
    <input type="text" id="vehicleSearch" class="form-control" placeholder="Search by driver, plate, or vehicle name...">
  </div>

  <!-- Vehicles Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body table-responsive">
      {% if vehicles %}
      <table class="table table-bordered table-hover align-middle" id="vehicleTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Driver</th>
            <th>Vehicle Name</th>
            <th>Type</th>
            <th>Plate</th>
            <th>CR No.</th>
            <th>OR No.</th>
            <th>VIN</th>
            <th>Year</th>
            <th>Expiry</th>
            <th>QR Code</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for vehicle in vehicles %}
          <tr>
            <td>{{ forloop.counter0|add:vehicles.start_index }}</td>
            <td>
              {% if vehicle.assigned_driver %}
                {{ vehicle.assigned_driver.first_name }} {{ vehicle.assigned_driver.last_name }}
              {% else %}
                <span class="text-muted">Unassigned</span>
              {% endif %}
            </td>
            <td>{{ vehicle.vehicle_name }}</td>
            <td>{{ vehicle.get_vehicle_type_display }}</td>
            <td>{{ vehicle.license_plate }}</td>
            <td>{{ vehicle.cr_number }}</td>
            <td>{{ vehicle.or_number }}</td>
            <td>{{ vehicle.vin_number }}</td>
            <td>{{ vehicle.year_model }}</td>
            <td>
              {% if vehicle.registration_expiry %}
                {{ vehicle.registration_expiry|date:"M d, Y" }}
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>
              {% if vehicle.qr_code %}
                <a href="{% url 'vehicles:vehicle_qr' vehicle.id %}" 
                   class="btn btn-outline-secondary btn-sm" target="_blank">
                  <i class="bi bi-printer"></i> View / Print
                </a>
              {% else %}
                <span class="text-muted">No QR</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_superuser or user.role == 'admin' %}
                <button class="btn btn-danger btn-sm btn-delete-item"
                        data-url="{% url 'vehicles:delete_vehicle' vehicle.id %}"
                        data-type="Vehicle">
                  <i class="bi bi-trash"></i> Delete
                </button>
              {% else %}
                <span class="text-muted">No Action</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="12" class="text-center text-muted py-3">No vehicles found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-center text-muted mb-0">No vehicles registered yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Pagination -->
  {% if vehicles.has_other_pages %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      {% if vehicles.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ vehicles.previous_page_number }}">&laquo; Prev</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">&laquo; Prev</span></li>
      {% endif %}

      {% for i in vehicles.paginator.page_range %}
        {% if vehicles.number == i %}
          <li class="page-item active"><span class="page-link">{{ i }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
        {% endif %}
      {% endfor %}

      {% if vehicles.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ vehicles.next_page_number }}">Next &raquo;</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next &raquo;</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  <!-- Back Button -->
  <div class="mt-3 text-end">
    <a href="{% url 'accounts:staff_dashboard' %}" 
      class="btn btn-secondary btn-lg">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>
</div>

<!-- Search Filter + Delete Script -->
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Search filter
  $('#vehicleSearch').on('keyup', function() {
    const value = $(this).val().toLowerCase();
    $("#vehicleTable tbody tr").filter(function() {
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
    });
  });

  // Delete vehicle
  document.querySelectorAll('.btn-delete-item').forEach(btn => {
    btn.addEventListener('click', function() {
      const url = this.dataset.url;
      const type = this.dataset.type || 'Item';
      if (confirm(`Are you sure you want to delete this ${type}?`)) {
        fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(`${type} deleted successfully.`);
            location.reload();
          } else {
            alert('❌ Failed to delete ' + type);
          }
        })
        .catch(() => alert('❌ Error deleting ' + type));
      }
    });
  });
});
</script>
{% endblock %}
