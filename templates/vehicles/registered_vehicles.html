{% extends "base.html" %}
{% load static %}

{% block title %}Registered Vehicles | RDFS{% endblock %}

{% block content %}

<style>
/* =====================================================
   RDFS – REGISTERED VEHICLES (SCOPED)
===================================================== */
.rdfs-vehicles-scope{
  --rdfs-blue:#112666;
  --rdfs-blue-dark:#0c1c4a;
  --rdfs-accent:#2563eb;
  --rdfs-soft:#e8f4fd;

  --rdfs-text:#0f172a;
  --rdfs-muted:#64748b;

  --gray-100:#f7fafc;
  --gray-200:#edf2f7;
  --gray-300:#e2e8f0;

  --shadow-sm:0 1px 3px rgba(0,0,0,.08);
  --shadow-md:0 8px 18px rgba(0,0,0,.12);

  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
  color:var(--rdfs-text);
}

/* HEADER */
.rdfs-vehicles-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:1rem;
  margin-bottom:1.25rem;
}

.rdfs-vehicles-title{
  font-weight:800;
  color:var(--rdfs-blue-dark);
}

.rdfs-vehicles-subtitle{
  font-size:.9rem;
  color:var(--rdfs-muted);
}

/* RETURN BUTTON */
.rdfs-vehicles-back{
  border-radius:999px;
  font-weight:600;
  background:#fff;
  color:var(--rdfs-blue-dark);
  border:1.5px solid var(--rdfs-blue);
  white-space:nowrap;
}

.rdfs-vehicles-back:hover{
  background:var(--rdfs-soft);
}

/* SEARCH BAR */
.rdfs-vehicles-search-wrap{
  display:flex;
  justify-content:flex-end;
  margin-bottom:1rem;
}

.rdfs-vehicles-search{
  position:relative;
  width:380px;
}

.rdfs-vehicles-search-icon{
  position:absolute;
  left:16px;
  top:50%;
  transform:translateY(-50%);
  color:var(--rdfs-muted);
  font-size:.95rem;
}

.rdfs-vehicles-search input{
  height:46px;
  width:100%;
  padding-left:44px;
  padding-right:86px;
  border-radius:999px;
  border:1.5px solid var(--gray-300);
  background:var(--gray-100);
  font-size:.9rem;
  transition:.2s ease;
}

.rdfs-vehicles-search input::placeholder{
  color:var(--rdfs-muted);
}

.rdfs-vehicles-search input:focus{
  outline:none;
  background:#fff;
  border-color:var(--rdfs-accent);
  box-shadow:0 0 0 4px rgba(37,99,235,.15);
}

.rdfs-vehicles-search button{
  position:absolute;
  right:6px;
  top:50%;
  transform:translateY(-50%);
  height:34px;
  padding:0 16px;
  border-radius:999px;
  font-weight:700;
  font-size:.8rem;
  background:linear-gradient(135deg,var(--rdfs-accent),var(--rdfs-blue));
  border:none;
  color:#fff;
}

/* CARD */
.rdfs-vehicles-card{
  border-radius:18px;
  box-shadow:var(--shadow-md);
  border:1px solid var(--gray-200);
}
</style>

<div class="rdfs-vehicles-scope p-4">

  <!-- HEADER -->
  <div class="rdfs-vehicles-header">
    <div>
      <h3 class="rdfs-vehicles-title mb-1">
        <i class="bi bi-truck-front-fill me-2"></i>
        Registered Vehicles
      </h3>
      <p class="rdfs-vehicles-subtitle mb-0">
        View, search, and manage registered vehicles in the system.
      </p>
    </div>

    <a href="{% url 'accounts:staff_dashboard' %}"
       class="btn rdfs-vehicles-back">
      <i class="bi bi-arrow-left-circle me-1"></i>
      Return to Dashboard
    </a>
  </div>

  <!-- SEARCH -->
  <div class="rdfs-vehicles-search-wrap">
    <form class="rdfs-vehicles-search" onsubmit="return false;">
      <i class="bi bi-search rdfs-vehicles-search-icon"></i>
      <input
        type="text"
        id="rdfsVehicleSearch"
        placeholder="Search by driver, plate, type, or name…"
      />
      <button type="submit">Search</button>
    </form>
  </div>

  <!-- MESSAGES -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- TABLE -->
  <div class="card rdfs-vehicles-card">
    <div class="card-body table-responsive">

      {% if vehicles %}
      <table class="table table-bordered table-hover align-middle"
             id="rdfsVehicleTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Driver</th>
            <th>Vehicle Name</th>
            <th>Type</th>
            <th>Plate</th>
            <th>CR No.</th>
            <th>OR No.</th>
            <th>VIN</th>
            <th>Year</th>
            <th>Expiry</th>
            <th>QR Code</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for vehicle in vehicles %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>
              {% if vehicle.assigned_driver %}
                {{ vehicle.assigned_driver.first_name }}
                {{ vehicle.assigned_driver.last_name }}
              {% else %}
                <span class="text-muted">Unassigned</span>
              {% endif %}
            </td>
            <td>{{ vehicle.vehicle_name }}</td>
            <td>{{ vehicle.get_vehicle_type_display }}</td>
            <td>{{ vehicle.license_plate }}</td>
            <td>{{ vehicle.cr_number }}</td>
            <td>{{ vehicle.or_number }}</td>
            <td>{{ vehicle.vin_number }}</td>
            <td>{{ vehicle.year_model }}</td>
            <td>{{ vehicle.registration_expiry|date:"M d, Y"|default:"N/A" }}</td>
            <td>
              {% if vehicle.qr_code %}
                <a href="{% url 'vehicles:vehicle_qr' vehicle.id %}"
                   target="_blank"
                   class="btn btn-outline-secondary btn-sm rounded-pill">
                  <i class="bi bi-printer-fill me-1"></i> View / Print
                </a>
              {% else %}
                <span class="text-muted">No QR</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_superuser or user.role == 'admin' %}
                <button class="btn btn-danger btn-sm btn-delete-item"
                        data-url="{% url 'vehicles:delete_vehicle' vehicle.id %}"
                        data-type="Vehicle">
                  <i class="bi bi-trash-fill me-1"></i> Delete
                </button>
              {% else %}
                <span class="text-muted">No Action</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="text-center text-muted">No vehicles registered yet.</p>
      {% endif %}

    </div>
  </div>

</div>

<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded",function(){

  /* SEARCH FILTER */
  $('#rdfsVehicleSearch').on('keyup',function(){
    const value=$(this).val().toLowerCase();
    $('#rdfsVehicleTable tbody tr').filter(function(){
      $(this).toggle($(this).text().toLowerCase().indexOf(value)>-1);
    });
  });

  /* DELETE HANDLER */
  document.querySelectorAll('.btn-delete-item').forEach(btn=>{
    btn.addEventListener('click',function(){
      const url=this.dataset.url;
      const type=this.dataset.type||'Item';
      if(confirm(`Are you sure you want to delete this ${type}?`)){
        fetch(url,{
          method:'POST',
          headers:{'X-CSRFToken':'{{ csrf_token }}'}
        })
        .then(r=>r.json())
        .then(d=>{
          if(d.success){
            alert(`${type} deleted successfully.`);
            location.reload();
          }else{
            alert(`❌ Failed to delete ${type}`);
          }
        })
        .catch(()=>alert(`❌ Error deleting ${type}`));
      }
    });
  });

});
</script>

{% endblock %}
