{% extends "base.html" %}
{% load static %}

{% block title %}Register Vehicle | RDFS{% endblock %}

{% block content %}

<style>
:root{
  --rdfs-blue:#112666;
  --rdfs-blue-dark:#0c1c4a;
  --rdfs-accent:#2563eb;
  --rdfs-soft:#e8f4fd;
  --text:#0f172a;
  --muted:#64748b;
  --gray-200:#edf2f7;
  --gray-300:#e2e8f0;
  --shadow-sm:0 1px 3px rgba(0,0,0,.08);
  --shadow-md:0 8px 18px rgba(0,0,0,.12);
}

body{
  background:linear-gradient(180deg,#ffffff 0%,#f2f6ff 100%);
  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
}

/* PAGE HEADER */
.rdfs-page-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:1.5rem;
}

.rdfs-page-title{
  font-weight:800;
  font-size:1.6rem;
  color:var(--rdfs-blue-dark);
}

.rdfs-page-sub{
  font-size:.9rem;
  color:var(--muted);
}

/* RETURN BUTTON */
.rdfs-return-btn{
  position:sticky;
  top:1rem;
  z-index:10;
  border-radius:999px;
  font-weight:700;
  padding:.55rem 1.2rem;
  background:#fff;
  color:var(--rdfs-blue-dark);
  border:2px solid var(--rdfs-blue);
  box-shadow:var(--shadow-sm);
  text-decoration:none;
}
.rdfs-return-btn:hover{
  background:var(--rdfs-soft);
}

/* CONTAINER */
.form-container{
  max-width:1200px;
  margin:auto;
}

/* SECTIONS */
.section-box{
  background:#fff;
  border-radius:18px;
  padding:1.8rem;
  box-shadow:var(--shadow-md);
  margin-bottom:2rem;
  border:1px solid var(--gray-200);
}

.section-title{
  font-weight:800;
  font-size:1.2rem;
  color:var(--rdfs-blue-dark);
  margin-bottom:1rem;
  padding-bottom:0.75rem;
  border-bottom: 2px solid var(--gray-200);
}

/* FORM ROWS */
.form-row {
  display: flex;
  flex-wrap: wrap;
  margin-right: -10px;
  margin-left: -10px;
  margin-bottom: 1rem;
}

.form-group {
  padding-right: 10px;
  padding-left: 10px;
  margin-bottom: 1rem;
  flex: 0 0 100%;
  max-width: 100%;
}

@media (min-width: 768px) {
  .col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
  }
  .col-md-4 {
    flex: 0 0 33.333333%;
    max-width: 33.333333%;
  }
  .col-md-3 {
    flex: 0 0 25%;
    max-width: 25%;
  }
}

/* LABELS */
.form-label {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 0.5rem;
  display: inline-block;
}

.required::after {
  content: " *";
  color: #dc3545;
}

/* INPUTS */
input, select {
  width: 100%;
  height: 50px !important;
  border-radius: 10px !important;
  border: 1.5px solid #cfd8e2 !important;
  padding: 12px 14px !important;
  font-size: 1rem;
  transition: all 0.2s ease-in-out;
}

input:focus, select:focus {
  border-color: var(--rdfs-accent) !important;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15) !important;
  outline: none;
}

/* DATE PICKER */
.date-wrapper { 
  position: relative;
  width: 100%;
}

.date-wrapper input {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364708b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 20px;
  cursor: pointer;
  padding-right: 40px !important;
}

/* BUTTONS */
.btn-submit {
  background: linear-gradient(135deg, var(--rdfs-accent), var(--rdfs-blue));
  color: white;
  border: none;
  border-radius: 999px;
  padding: 0.75rem 2rem;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.btn-submit:active {
  transform: translateY(0);
}

/* FORM VALIDATION */
.is-invalid {
  border-color: #dc3545 !important;
  padding-right: calc(1.5em + 0.75rem) !important;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right calc(0.375em + 0.1875rem) center;
  background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.invalid-feedback {
  width: 100%;
  margin-top: 0.25rem;
  font-size: 0.875em;
  color: #dc3545;
  display: none;
}

.was-validated .form-control:invalid ~ .invalid-feedback,
.was-validated .form-control:invalid ~ .invalid-tooltip,
.form-control.is-invalid ~ .invalid-feedback,
.form-control.is-invalid ~ .invalid-tooltip {
  display: block;
}

/* CUSTOM CALENDAR */
.custom-calendar {
  position: absolute;
  top: 60px;
  width: 330px;
  background: #fff;
  border-radius: 14px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--gray-300);
  padding: 12px;
  display: none;
  z-index: 999;
  animation: fadeIn 0.15s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}

.cal-header {
  display: flex;
  justify-content: space-between;
  background: linear-gradient(135deg, var(--rdfs-blue), var(--rdfs-accent));
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 10px;
}

.cal-header select {
  border: none;
  border-radius: 8px;
  padding: 4px 8px;
  font-weight: 600;
  color: var(--rdfs-blue-dark);
  background: #fff;
  cursor: pointer;
}

.cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-bottom: 8px;
  text-align: center;
  font-weight: 600;
  color: var(--rdfs-blue-dark);
  font-size: 0.9em;
}

.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.cal-day {
  padding: 8px;
  text-align: center;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.cal-day:hover {
  background-color: var(--rdfs-soft);
}

.cal-day.today {
  font-weight: bold;
  border: 2px solid var(--rdfs-blue);
}

.cal-day.selected {
  background: var(--rdfs-blue);
  color: white;
  font-weight: bold;
}

.cal-day.other-month {
  color: #adb5bd;
  cursor: default;
}

.cal-day.other-month:hover {
  background: transparent;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .section-box {
    padding: 1.25rem;
  }
  
  .form-group {
    flex: 0 0 100%;
    max-width: 100%;
  }
  
  .rdfs-page-header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .rdfs-page-title {
    font-size: 1.4rem;
  }
}
.cal-day{
  height:40px;
  line-height:40px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  color:var(--text);
  transition:all .15s ease;
}

/* HOVER */
.cal-day:hover{
  background:var(--rdfs-soft);
  color:var(--rdfs-blue);
}

/* SELECTED */
.cal-day.selected{
  background:var(--rdfs-blue);
  color:#ffffff;
  font-weight:800;
  box-shadow:0 4px 10px rgba(17,38,102,.35);
}

/* TODAY */
.cal-day.today{
  border:2px solid var(--rdfs-accent);
  color:var(--rdfs-blue-dark);
  font-weight:700;
}


/* SUBMIT */
.rdfs-submit{
  border-radius:999px;
  font-weight:700;
  padding:.6rem 1.8rem;
  background:linear-gradient(135deg,var(--rdfs-accent),var(--rdfs-blue));
  border:none;
  color:#fff;
}
</style>

<div class="container py-4 form-container">
  <div class="rdfs-page-header">
    <div>
      <h1 class="rdfs-page-title">Register New Vehicle</h1>
      <p class="rdfs-page-sub">Fill in the details below to register a new vehicle</p>
    </div>
    <a href="{% url 'vehicles:registered_vehicles' %}" class="rdfs-return-btn">
      ‚Üê Back to Vehicles
    </a>
  </div>

  <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        <strong>Error:</strong> {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- Basic Information -->
    <div class="section-box">
      <h2 class="section-title">Basic Information</h2>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.vehicle_name.id_for_label }}" class="form-label">
            Vehicle Name
            <span class="text-muted">(Optional)</span>
          </label>
          <input type="text" 
                 name="{{ form.vehicle_name.name }}"
                 id="{{ form.vehicle_name.id_for_label }}"
                 class="form-control {% if form.vehicle_name.errors %}is-invalid{% endif %}"
                 placeholder="e.g. Toyota Grandia 2023"
                 value="{{ form.vehicle_name.value|default:'' }}">
          {% if form.vehicle_name.errors %}
            <div class="invalid-feedback">
              {{ form.vehicle_name.errors.0 }}
            </div>
          {% endif %}
          <small class="form-text text-muted">Enter the vehicle's model and make</small>
        </div>

        <div class="form-group col-md-6">
          <label for="{{ form.vehicle_type.id_for_label }}" class="form-label required">
            Vehicle Type
          </label>
          {{ form.vehicle_type }}
          {% if form.vehicle_type.errors %}
            <div class="invalid-feedback">
              {{ form.vehicle_type.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please select the vehicle type.
            </div>
          {% endif %}
          <small class="form-text text-muted">Select the type of vehicle</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.assigned_driver.id_for_label }}" class="form-label required">
            Assigned Driver
          </label>
          {{ form.assigned_driver }}
          {% if form.assigned_driver.errors %}
            <div class="invalid-feedback">
              {{ form.assigned_driver.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please select the driver assigned to this vehicle.
            </div>
          {% endif %}
          <small class="form-text text-muted">Select the driver assigned to this vehicle</small>
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.ownership_type.id_for_label }}" class="form-label required">
            Ownership Type
          </label>
          {{ form.ownership_type }}
          {% if form.ownership_type.errors %}
            <div class="invalid-feedback">
              {{ form.ownership_type.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please select the ownership type.
            </div>
          {% endif %}
          <small class="form-text text-muted">Select the ownership type</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.route.id_for_label }}" class="form-label">
            Route
            <span class="text-muted">(Optional)</span>
          </label>
          {{ form.route }}
          {% if form.route.errors %}
            <div class="invalid-feedback">
              {{ form.route.errors.0 }}
            </div>
          {% endif %}
          <small class="form-text text-muted">Select the regular route for this vehicle</small>
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.seat_capacity.id_for_label }}" class="form-label">
            Seat Capacity
            <span class="text-muted">(Optional)</span>
          </label>
          <input type="number" 
                 name="{{ form.seat_capacity.name }}"
                 id="{{ form.seat_capacity.id_for_label }}"
                 class="form-control {% if form.seat_capacity.errors %}is-invalid{% endif %}"
                 placeholder="e.g. 12"
                 min="1"
                 value="{{ form.seat_capacity.value|default:'' }}">
          {% if form.seat_capacity.errors %}
            <div class="invalid-feedback">
              {{ form.seat_capacity.errors.0 }}
            </div>
          {% endif %}
          <small class="form-text text-muted">Enter the maximum number of passengers</small>
        </div>
      </div>
    </div>

    <!-- Registration Information -->
    <div class="section-box">
      <h2 class="section-title">Registration Information</h2>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.cr_number.id_for_label }}" class="form-label required">
            CR Number
          </label>
          <input type="text" 
                 name="{{ form.cr_number.name }}"
                 id="{{ form.cr_number.id_for_label }}"
                 class="form-control {% if form.cr_number.errors %}is-invalid{% endif %}"
                 placeholder="e.g. 123456789012"
                 value="{{ form.cr_number.value|default:'' }}"
                 required>
          {% if form.cr_number.errors %}
            <div class="invalid-feedback">
              {{ form.cr_number.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please provide a valid CR number.
            </div>
          {% endif %}
          <small class="form-text text-muted">Enter the Certificate of Registration number</small>
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.or_number.id_for_label }}" class="form-label required">
            OR Number
          </label>
          <input type="text" 
                 name="{{ form.or_number.name }}"
                 id="{{ form.or_number.id_for_label }}"
                 class="form-control {% if form.or_number.errors %}is-invalid{% endif %}"
                 placeholder="e.g. 123456789012"
                 value="{{ form.or_number.value|default:'' }}"
                 required>
          {% if form.or_number.errors %}
            <div class="invalid-feedback">
              {{ form.or_number.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please provide a valid OR number.
            </div>
          {% endif %}
          <small class="form-text text-muted">Enter the Official Receipt number</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.vin_number.id_for_label }}" class="form-label required">
            VIN Number
          </label>
          <input type="text" 
                 name="{{ form.vin_number.name }}"
                 id="{{ form.vin_number.id_for_label }}"
                 class="form-control {% if form.vin_number.errors %}is-invalid{% endif %}"
                 placeholder="e.g. JT2BF22K1W0123456"
                 value="{{ form.vin_number.value|default:'' }}"
                 required>
          {% if form.vin_number.errors %}
            <div class="invalid-feedback">
              {{ form.vin_number.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please provide a valid 17-character VIN number.
            </div>
          {% endif %}
          <small class="form-text text-muted">Enter the 17-character Vehicle Identification Number</small>
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.year_model.id_for_label }}" class="form-label required">
            Year Model
          </label>
          {{ form.year_model }}
          {% if form.year_model.errors %}
            <div class="invalid-feedback">
              {{ form.year_model.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please select the vehicle's year model.
            </div>
          {% endif %}
          <small class="form-text text-muted">Select the vehicle's manufacturing year</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.registration_number.id_for_label }}" class="form-label required">
            Registration Number
          </label>
          <input type="text" 
                 name="{{ form.registration_number.name }}"
                 id="{{ form.registration_number.id_for_label }}"
                 class="form-control {% if form.registration_number.errors %}is-invalid{% endif %}"
                 placeholder="e.g. NX123456"
                 value="{{ form.registration_number.value|default:'' }}"
                 required>
          {% if form.registration_number.errors %}
            <div class="invalid-feedback">
              {{ form.registration_number.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please provide a valid registration number.
            </div>
          {% endif %}
          <small class="form-text text-muted">Enter the vehicle's registration number</small>
        </div>
        
        <div class="form-group col-md-6">
          <div class="date-wrapper">
            <label for="{{ form.registration_expiry.id_for_label }}" class="form-label required">
              Registration Expiry
            </label>
            <input type="text" 
                   name="{{ form.registration_expiry.name }}"
                   id="{{ form.registration_expiry.id_for_label }}"
                   class="form-control {% if form.registration_expiry.errors %}is-invalid{% endif %}"
                   placeholder="YYYY-MM-DD"
                   value="{{ form.registration_expiry.value|default:'' }}"
                   autocomplete="off"
                   required>
            {% if form.registration_expiry.errors %}
              <div class="invalid-feedback">
                {{ form.registration_expiry.errors.0 }}
              </div>
            {% else %}
              <div class="invalid-feedback">
                Please select the registration expiry date.
              </div>
            {% endif %}
            <div id="calendar_regexpiry" class="custom-calendar"></div>
            <small class="form-text text-muted">Click to select the registration expiry date</small>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.license_plate.id_for_label }}" class="form-label required">
            License Plate
          </label>
          <input type="text" 
                 name="{{ form.license_plate.name }}"
                 id="{{ form.license_plate.id_for_label }}"
                 class="form-control {% if form.license_plate.errors %}is-invalid{% endif %}"
                 placeholder="e.g. ABC123"
                 value="{{ form.license_plate.value|default:'' }}"
                 required>
          {% if form.license_plate.errors %}
            <div class="invalid-feedback">
              {{ form.license_plate.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              Please provide a valid license plate number.
            </div>
          {% endif %}
          <small class="form-text text-muted">Enter the vehicle's license plate number</small>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end mt-4">
      <button type="submit" class="btn-submit">
        Register Vehicle
      </button>
    </div>
  </form>
</div>

<!-- Select2 -->
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet">
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'js/select2.min.js' %}"></script>

<script>
$(document).ready(function() {
  $('#id_assigned_driver').select2({ width: '100%' });
  $('#id_route').select2({ width: '100%' });
});
</script>


<!-- YEAR MODEL DROPDOWN -->
<script>
const yearSelect = document.getElementById("id_year_model");
const currentYear = new Date().getFullYear();

for (let y = 2000; y <= currentYear; y++) {
  let opt = document.createElement("option");
  opt.value = y;
  opt.textContent = y;
  yearSelect.appendChild(opt);
}

// Make dropdown height short
yearSelect.style.maxHeight = "38px";
yearSelect.style.padding = "6px 10px";
</script>


<!-- CUSTOM CALENDAR -->
<script>
function createCalendar(inputId, calendarId, minYear, maxYear) {

  const input = document.getElementById(inputId);
  const wrapper = document.getElementById(inputId).parentElement;
  const box = wrapper.querySelector(".custom-calendar");


  input.type = "text"; // force text for styling

  let today = new Date();
  let month = today.getMonth();
  let year = today.getFullYear();

  function render() {
    box.innerHTML = "";

    // HEADER
    let header = document.createElement("div");
    header.className = "cal-header";

    // MONTH SELECT
    let monthSel = document.createElement("select");
    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];

    monthNames.forEach((m, i) => {
      let opt = document.createElement("option");
      opt.value = i;
      opt.textContent = m;
      if (i === month) opt.selected = true;
      monthSel.appendChild(opt);
    });

    // YEAR SELECT
    let yearSel = document.createElement("select");
    yearSel.className = "year-select";

    for (let y = minYear; y <= maxYear; y++) {
      let opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      if (y === year) opt.selected = true;
      yearSel.appendChild(opt);
    }

    monthSel.onchange = () => { month = parseInt(monthSel.value); render(); };
    yearSel.onchange = () => { year = parseInt(yearSel.value); render(); };

    header.appendChild(monthSel);
    header.appendChild(yearSel);
    box.appendChild(header);

    // WEEKDAYS
    let daysRow = document.createElement("div");
    daysRow.className = "cal-days";
    ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"].forEach(d => {
      let el = document.createElement("div");
      el.textContent = d;
      daysRow.appendChild(el);
    });
    box.appendChild(daysRow);

    // DAYS GRID
    let grid = document.createElement("div");
    grid.className = "cal-grid";
    box.appendChild(grid);

    const firstDay = new Date(year, month, 1).getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
      grid.appendChild(document.createElement("div"));
    }

    for (let d = 1; d <= totalDays; d++) {
      let day = document.createElement("div");
      day.className = "cal-day";
      day.textContent = d;

      let today = new Date();
      if (year === today.getFullYear() &&
          month === today.getMonth() &&
          d === today.getDate()) {
        day.classList.add("today");
      }

      day.onclick = () => {
        input.value = `${year}-${String(month + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        box.style.display = "none";
      };

      grid.appendChild(day);
    }
  }

  // OPEN CALENDAR BELOW INPUT
  input.addEventListener("click", () => {
    box.style.display = "block";
    render();
  });

  // CLOSE CALENDAR WHEN CLICKING OUTSIDE
  document.addEventListener("click", (e) => {
    if (!wrapper.contains(e.target)) {
      box.style.display = "none";
    }
  });
}

createCalendar("id_registration_expiry", "calendar_regexpiry", 2000, 2045);
</script>

{% endblock %}
