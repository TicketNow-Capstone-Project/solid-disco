{% extends "base.html" %}
{% load static %}

{% block title %}Register Vehicle | RDFS{% endblock %}

{% block content %}

<style>
 /* =====================================================
   RDFS – REGISTER VEHICLE
===================================================== */
:root{
  --rdfs-blue:#112666;
  --rdfs-blue-dark:#0c1c4a;
  --rdfs-accent:#2563eb;
  --rdfs-soft:#e8f4fd;

  --text:#0f172a;
  --muted:#64748b;

  --gray-200:#edf2f7;
  --gray-300:#e2e8f0;

  --shadow-sm:0 1px 3px rgba(0,0,0,.08);
  --shadow-md:0 8px 18px rgba(0,0,0,.12);
}

body{
  background:linear-gradient(180deg,#ffffff 0%,#f2f6ff 100%) !important;
  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
}

/* PAGE HEADER */
.rdfs-page-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:1.5rem;
}

.rdfs-page-title{
  font-weight:800;
  font-size:1.6rem;
  color:var(--rdfs-blue-dark);
}

.rdfs-page-sub{
  font-size:.9rem;
  color:var(--muted);
}

/* RETURN BUTTON */
.rdfs-return-btn{
  position:sticky;
  top:1rem;
  z-index:10;
  border-radius:999px;
  font-weight:700;
  padding:.55rem 1.2rem;
  background:#fff;
  color:var(--rdfs-blue-dark);
  border:2px solid var(--rdfs-blue);
  box-shadow:var(--shadow-sm);
  text-decoration:none;
}
.rdfs-return-btn:hover{
  background:var(--rdfs-soft);
}

/* CONTAINER */
.form-container{
  max-width:1200px;
  margin:auto;
}

/* SECTIONS */
.section-box{
  background:#fff;
  border-radius:18px;
  padding:2rem;
  margin-bottom:2rem;
  border:1px solid var(--gray-200);
  box-shadow:var(--shadow-md);
  transition:.2s ease;
}
.section-box:hover{
  transform:translateY(-2px);
}

/* SECTION TITLE */
.section-title{
  font-size:1.25rem;
  font-weight:800;
  color:var(--rdfs-blue-dark);
  margin-bottom:1.4rem;
}

/* LABELS */
.form-group label{
  font-size:.9rem;
  font-weight:600;
  color:var(--text);
}
.required::after{
  content:" *";
  color:#dc3545;
}

/* INPUTS */
.form-group input,
.form-group select{
  height:48px !important;
  border-radius:10px;
  border:1.5px solid var(--gray-300);
  padding:10px 14px;
  transition:.2s;
}
.form-group input:focus,
.form-group select:focus{
  border-color:var(--rdfs-accent);
  box-shadow:0 0 0 3px rgba(37,99,235,.18);
}

/* DATE PICKER */
.date-wrapper{ position:relative; max-width:260px; }
.date-wrapper input{
  background-image:url("https://cdn-icons-png.flaticon.com/512/747/747310.png");
  background-repeat:no-repeat;
  background-size:20px;
  background-position:right 12px center;
  cursor:pointer;
}

/* ==========================================
   RDFS – CUSTOM CALENDAR (REFINED)
========================================== */

.custom-calendar{
  position:absolute;
  top:54px;
  width:300px;
  background:#ffffff;
  border-radius:14px;
  padding:12px;
  border:1px solid var(--gray-300);
  box-shadow:0 8px 20px rgba(17,38,102,.18);
  display:none;
  z-index:9999;
  animation:fadeIn .15s ease-out;
}

/* Fade animation */
@keyframes fadeIn{
  from{opacity:0;transform:translateY(-6px)}
  to{opacity:1;transform:translateY(0)}
}

/* HEADER */
.cal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:linear-gradient(135deg,var(--rdfs-blue),var(--rdfs-accent));
  padding:10px;
  border-radius:10px;
}

.cal-header select{
  border:none;
  background:#ffffff;
  border-radius:8px;
  padding:5px 8px;
  font-weight:700;
  font-size:14px;
  color:var(--rdfs-blue-dark);
  box-shadow:0 1px 3px rgba(0,0,0,.15);
  cursor:pointer;
}

/* WEEKDAY LABELS */
.cal-days{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  margin-top:10px;
  text-align:center;
  font-weight:700;
  font-size:13px;
  color:var(--rdfs-blue-dark);
}

/* GRID */
.cal-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  margin-top:6px;
}

/* DAY CELL */
.cal-day{
  height:40px;
  line-height:40px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  color:var(--text);
  transition:all .15s ease;
}

/* HOVER */
.cal-day:hover{
  background:var(--rdfs-soft);
  color:var(--rdfs-blue);
}

/* SELECTED */
.cal-day.selected{
  background:var(--rdfs-blue);
  color:#ffffff;
  font-weight:800;
  box-shadow:0 4px 10px rgba(17,38,102,.35);
}

/* TODAY */
.cal-day.today{
  border:2px solid var(--rdfs-accent);
  color:var(--rdfs-blue-dark);
  font-weight:700;
}


/* SUBMIT */
.rdfs-submit{
  border-radius:999px;
  font-weight:700;
  padding:.6rem 1.8rem;
  background:linear-gradient(135deg,var(--rdfs-accent),var(--rdfs-blue));
  border:none;
  color:#fff;
}
</style>


<div class="container py-4 form-container">

 <div class="rdfs-page-header">
    <div>
      <div class="rdfs-page-title">
        <i class="bi bi-truck-front-fill me-2"></i> Register Vehicle
      </div>
      <div class="rdfs-page-sub">
        Add a new vehicle to the RDFS system
      </div>
    </div>

    <a href="{% url 'accounts:staff_dashboard' %}" class="rdfs-return-btn">
      <i class="bi bi-arrow-left-circle me-1"></i> Dashboard
    </a>
  </div>
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger"><strong>Error:</strong> {{ form.non_field_errors }}</div>
  {% endif %}


  <form method="POST" enctype="multipart/form-data"
        hx-post="{% url 'vehicles:register_vehicle' %}"
        hx-target="#main-content"
        hx-swap="innerHTML transition:true"
        id="vehicleForm">

    {% csrf_token %}

        <!-- VEHICLE DETAILS -->
    <div class="section-box">
      <div class="section-title">Vehicle Details</div>

      <div class="row g-3">

        <div class="col-md-6 form-group">
          <label class="required">Vehicle Name</label>
          {{ form.vehicle_name }}
        </div>

        <div class="col-md-6 form-group">
          <label class="required">Vehicle Type</label>
          {{ form.vehicle_type }}
        </div>

        <div class="col-md-6 form-group">
          <label class="required">Ownership Type</label>
          {{ form.ownership_type }}
        </div>

        <div class="col-md-6 form-group">
          <label class="required">Route</label>
          {{ form.route }}
        </div>

        <div class="col-md-6 form-group">
          <label class="required">Seat Capacity</label>
          {{ form.seat_capacity }}
        </div>

      </div>
    </div>


    <!-- REGISTRATION DETAILS -->
    <div class="section-box">
      <div class="section-title">Registration Details</div>

      <div class="row g-3">

        <div class="col-md-6 form-group">
          <label class="required">Registration Number</label>
          {{ form.registration_number }}
        </div>

        <div class="col-md-4 form-group date-wrapper">
          <label class="required">Registration Expiry</label>
          {{ form.registration_expiry }}
          <div id="calendar_regexpiry" class="custom-calendar"></div>
        </div>

        <div class="col-md-6 form-group">
          <label class="required">Year Model</label>

          <!-- Replaced NumberInput with safe frontend-only dropdown -->
          <select id="id_year_model" name="year_model" class="form-select year-select"></select>

        </div>

        <div class="col-md-6 form-group">
          <label class="required">License Plate</label>
          {{ form.license_plate }}
        </div>

      </div>
    </div>

        <!-- VEHICLE IDENTIFICATION -->
    <div class="section-box">
      <div class="section-title">Vehicle Identification</div>

      <div class="row g-3">

        <div class="col-md-6 form-group">
          <label class="required">CR Number</label>
          {{ form.cr_number }}
        </div>

        <div class="col-md-6 form-group">
          <label class="required">OR Number</label>
          {{ form.or_number }}
        </div>

        <div class="col-md-6 form-group">
          <label class="required">VIN Number</label>
          {{ form.vin_number }}
        </div>

      </div>
    </div>


    <!-- DRIVER ASSIGNMENT -->
    <div class="section-box">
      <div class="section-title">Driver Assignment</div>

      <div class="form-group">
        <label class="required">Assigned Driver</label>
        {{ form.assigned_driver }}
      </div>

    </div>


    <!-- FOOTER BUTTONS -->
    <div class="d-flex justify-content-between mt-4">

      

      <button type="submit" class="btn btn-success px-4">
        <i class="bi bi-check-circle-fill me-1"></i> Register Vehicle
      </button>

    </div>

  </form>
</div>

<!-- Select2 -->
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet">
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'js/select2.min.js' %}"></script>

<script>
$(document).ready(function() {
  $('#id_assigned_driver').select2({ width: '100%' });
  $('#id_route').select2({ width: '100%' });
});
</script>


<!-- YEAR MODEL DROPDOWN -->
<script>
const yearSelect = document.getElementById("id_year_model");
const currentYear = new Date().getFullYear();

for (let y = 2000; y <= currentYear; y++) {
  let opt = document.createElement("option");
  opt.value = y;
  opt.textContent = y;
  yearSelect.appendChild(opt);
}

// Make dropdown height short
yearSelect.style.maxHeight = "38px";
yearSelect.style.padding = "6px 10px";
</script>


<!-- CUSTOM CALENDAR -->
<script>
function createCalendar(inputId, calendarId, minYear, maxYear) {

  const input = document.getElementById(inputId);
  const wrapper = document.getElementById(inputId).parentElement;
  const box = wrapper.querySelector(".custom-calendar");


  input.type = "text"; // force text for styling

  let today = new Date();
  let month = today.getMonth();
  let year = today.getFullYear();

  function render() {
    box.innerHTML = "";

    // HEADER
    let header = document.createElement("div");
    header.className = "cal-header";

    // MONTH SELECT
    let monthSel = document.createElement("select");
    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];

    monthNames.forEach((m, i) => {
      let opt = document.createElement("option");
      opt.value = i;
      opt.textContent = m;
      if (i === month) opt.selected = true;
      monthSel.appendChild(opt);
    });

    // YEAR SELECT
    let yearSel = document.createElement("select");
    yearSel.className = "year-select";

    for (let y = minYear; y <= maxYear; y++) {
      let opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      if (y === year) opt.selected = true;
      yearSel.appendChild(opt);
    }

    monthSel.onchange = () => { month = parseInt(monthSel.value); render(); };
    yearSel.onchange = () => { year = parseInt(yearSel.value); render(); };

    header.appendChild(monthSel);
    header.appendChild(yearSel);
    box.appendChild(header);

    // WEEKDAYS
    let daysRow = document.createElement("div");
    daysRow.className = "cal-days";
    ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"].forEach(d => {
      let el = document.createElement("div");
      el.textContent = d;
      daysRow.appendChild(el);
    });
    box.appendChild(daysRow);

    // DAYS GRID
    let grid = document.createElement("div");
    grid.className = "cal-grid";
    box.appendChild(grid);

    const firstDay = new Date(year, month, 1).getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
      grid.appendChild(document.createElement("div"));
    }

    for (let d = 1; d <= totalDays; d++) {
      let day = document.createElement("div");
      day.className = "cal-day";
      day.textContent = d;

      let today = new Date();
      if (year === today.getFullYear() &&
          month === today.getMonth() &&
          d === today.getDate()) {
        day.classList.add("today");
      }

      day.onclick = () => {
        input.value = `${year}-${String(month + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        box.style.display = "none";
      };

      grid.appendChild(day);
    }
  }

  // OPEN CALENDAR BELOW INPUT
  input.addEventListener("click", () => {
    box.style.display = "block";
    render();
  });

  // CLOSE CALENDAR WHEN CLICKING OUTSIDE
  document.addEventListener("click", (e) => {
    if (!wrapper.contains(e.target)) {
      box.style.display = "none";
    }
  });
}

createCalendar("id_registration_expiry", "calendar_regexpiry", 2000, 2045);
</script>

{% endblock %}
