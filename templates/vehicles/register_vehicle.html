{% extends "base.html" %}
{% load static %}

{% block title %}Register Vehicle | TicketNow{% endblock %}

{% block content %}
  <div class="container py-4">
    <div class="mx-auto p-4 bg-white shadow rounded" style="max-width: 1200px;">
    <h3 class="fw-bold mb-2"><i class="bi bi-truck"></i> Register Vehicle</h3>
    <p class="text-muted mb-4">
      Fill in all required fields (<span class="text-danger">*</span>) to register a vehicle and link it to a driver.
    </p>

    <!-- Flash Messages -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger"><strong>Form Error:</strong> {{ form.non_field_errors }}</div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data"
          hx-post="{% url 'vehicles:register_vehicle' %}"
          hx-target="#main-content"
          hx-swap="innerHTML transition:true"
          id="vehicleForm">
      {% csrf_token %}

      <!-- Assign Driver -->
      <div class="mb-3">
        <label class="form-label fw-bold required">Assign Driver</label>
        {% if form.assigned_driver.errors %}
          <div class="form-control border-danger p-0">{{ form.assigned_driver }}</div>
          <div class="text-danger small mt-1">{{ form.assigned_driver.errors|striptags }}</div>
        {% else %}
          {{ form.assigned_driver }}
        {% endif %}
        <div class="form-text text-muted">Search and select a registered driver.</div>
      </div>

      <!-- Vehicle Fields -->
      <div class="row g-3">
        {% for field in form %}
          {% if field.name != 'assigned_driver' %}
          <div class="col-md-6">
            <label class="form-label fw-bold">
              {{ field.label }}
              {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>

            {% if field.errors %}
              <div class="form-control border-danger p-0">{{ field }}</div>
              <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
            {% else %}
              {{ field }}
            {% endif %}
          </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Buttons -->
      <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'accounts:staff_dashboard' %}"
           hx-get="{% url 'accounts:staff_dashboard' %}"
           hx-target="#main-content"
           hx-swap="innerHTML transition:true"
           class="btn btn-outline-secondary">
          ← Back to Dashboard
        </a>

        <button type="submit" class="btn btn-success px-4">
          ✔ Register Vehicle
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Select2 Support -->
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet">
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/select2.min.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  if (window.$ && $.fn && $.fn.select2) {
    $('#id_assigned_driver, #id_route').select2({
      placeholder: "Select option...",
      allowClear: true,
      width: '100%'
    });
  }

  const invalid = document.querySelector('.border-danger input, .border-danger select');
  if (invalid) invalid.focus();
});
</script>

<style>
.required::after {
  content: " *";
  color: red;
}
select.form-control, select.form-select {
  width: 100% !important;
}
</style>

{% endblock %}
