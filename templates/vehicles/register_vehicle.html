{% extends 'base.html' %}
{% load static %}
{% block title %}Register Vehicle | TicketNow{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 bg-light sidebar p-3">
      {% include 'includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 p-4">
      <h3 class="mb-3"><i class="bi bi-truck"></i> Register Vehicle</h3>
      <p class="text-muted">
        Fill in all required fields (<span class="text-danger">*</span>) to register a vehicle and link it to a driver.
      </p>

      {% if form.non_field_errors %}
      <div class="alert alert-danger">
        <strong>Form Error:</strong> {{ form.non_field_errors }}
      </div>
      {% endif %}

      <!-- Flash Messages -->
      {% if messages %}
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %}
      {% endif %}

      <!-- Vehicle Registration Form -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <form method="POST" action="{% url 'vehicles:register_vehicle' %}" novalidate>
            {% csrf_token %}

            <!-- Assigned Driver -->
            <div class="mb-3">
              <label class="form-label fw-bold">
                Assign Driver <span class="text-danger">*</span>
              </label>
              {% if form.assigned_driver.errors %}
                <div class="form-control border-danger p-0">{{ form.assigned_driver }}</div>
                <div class="text-danger small mt-1">{{ form.assigned_driver.errors|striptags }}</div>
              {% else %}
                {{ form.assigned_driver }}
              {% endif %}
              <div class="form-text text-muted">Search and select a registered driver.</div>
            </div>

            <!-- Vehicle Information Fields -->
            <div class="row">
              {% for field in form %}
                {% if field.name != 'assigned_driver' %}
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">
                    {{ field.label }}
                    {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                  </label>

                  {% if field.errors %}
                    <div class="form-control border-danger p-0">{{ field }}</div>
                    <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
                  {% else %}
                    {% if field.name == 'manufacturer' %}
                      <div class="manufacturer-wrapper">
                        {{ field }}
                      </div>
                    {% else %}
                      {{ field }}
                    {% endif %}
                  {% endif %}
                </div>
                {% endif %}
              {% endfor %}
            </div>

            <!-- Actions -->
            <div class="text-end mt-3">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-save"></i> Register Vehicle
              </button>
              <a href="{% url 'staff_dashboard' %}" class="btn btn-secondary btn-lg">
                <i class="bi bi-arrow-left-circle"></i> Back to Dashboard
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Select2 Enhancement -->
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet">
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/select2.min.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // âœ… Enable Select2 only for the driver dropdown
  if (window.$ && $.fn && $.fn.select2) {
    $('#id_assigned_driver').select2({
      placeholder: "Search driver...",
      allowClear: true,
      width: '100%'
    });
  }

  // ðŸ›‘ Disable Select2 on manufacturer dropdown to keep native look
  if ($('#id_manufacturer').data('select2')) {
    $('#id_manufacturer').select2('destroy');
  }

  // ðŸ§¾ Force visible width and text color
  const manufacturerSelect = document.getElementById("id_manufacturer");
  if (manufacturerSelect) {
    manufacturerSelect.style.display = "block";
    manufacturerSelect.style.width = "100%";
    manufacturerSelect.style.color = "#212529";
    manufacturerSelect.style.backgroundColor = "#fff";
    manufacturerSelect.style.border = "1px solid #ced4da";
    manufacturerSelect.style.padding = "0.5rem";
  }

  // Auto-focus first invalid field
  const invalidField = document.querySelector('.border-danger input, .border-danger select');
  if (invalidField) invalidField.focus();
});
</script>

<style>
select,
select.form-select,
select.form-control {
  width: 100% !important;
  min-width: 200px !important;
  max-width: 100% !important;
  height: auto !important;
  color: #212529 !important;
  background-color: #fff !important;
  border: 1px solid #ced4da !important;
  border-radius: 0.375rem !important;
  padding: 0.5rem !important;
  display: block !important;
}

option {
  color: #000 !important;
  background-color: #fff !important;
}
</style>

{% endblock %}
