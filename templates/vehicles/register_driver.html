{% extends "base.html" %}
{% load static %}

{% block title %}Register Driver | TicketNow{% endblock %}

{% block content %}
<style>
  body {
    background-color: #f8f9fa;
  }

  .form-container {
    max-width: 1200px;
    margin: auto;
  }

  .section-box {
    background: #ffffff;
    border-radius: 12px;
    padding: 1.8rem;
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
  }

  .section-title {
    font-weight: 700;
    margin-bottom: 1rem;
    font-size: 1.25rem;
  }

  .required::after {
    content: " *";
    color: red;
    font-weight: bold;
  }

  #cameraArea {
    pointer-events: auto;
  }

  #cameraArea.hidden,
  #cameraArea[style*="display:none"] {
    pointer-events: none;
  }

</style>

<div class="container py-4 form-container">

  <h3 class="fw-bold mb-3"><i class="bi bi-person-plus"></i> Register Driver</h3>
  <p class="text-muted">Register a new driver with complete license and emergency details.</p>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger"><strong>Error:</strong> {{ form.non_field_errors }}</div>
  {% endif %}

  <form method="POST" enctype="multipart/form-data"
        hx-post="{% url 'vehicles:register_driver' %}"
        hx-target="#main-content"
        hx-swap="innerHTML transition:true"
        id="driverForm">
    {% csrf_token %}

    <!-- PERSONAL INFORMATION -->
    <div class="section-box">
      <div class="section-title">Personal Information</div>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label required">First Name</label>
          {{ form.first_name }}
        </div>

        <div class="col-md-3">
          <label class="form-label">Middle Name</label>
          {{ form.middle_name }}
        </div>

        <div class="col-md-3">
          <label class="form-label required">Last Name</label>
          {{ form.last_name }}
        </div>

        <div class="col-md-3">
          <label class="form-label">Suffix</label>
          {{ form.suffix }}
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label required">Birth Date</label>
          {{ form.birth_date }}
        </div>

        <div class="col-md-4">
          <label class="form-label">Birth Place</label>
          {{ form.birth_place }}
        </div>

        <div class="col-md-4">
          <label class="form-label required">Blood Type</label>
          {{ form.blood_type }}
        </div>
      </div>
    </div>

    <!-- CONTACT INFORMATION -->
    <div class="section-box">
      <div class="section-title">Contact Information</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label required">Mobile Number</label>
          {{ form.mobile_number }}
          <small class="text-muted">Format: +63 or 09...</small>
        </div>

        <div class="col-md-6">
          <label class="form-label required">Email Address</label>
          {{ form.email }}
        </div>
      </div>
    </div>

    <!-- ADDRESS INFORMATION -->
    <div class="section-box">
      <div class="section-title">Address Information</div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label required">Street</label>
          {{ form.street }}
        </div>

        <div class="col-md-4">
          <label class="form-label required">Barangay</label>
          {{ form.barangay }}
        </div>

        <div class="col-md-4">
          <label class="form-label required">ZIP Code</label>
          {{ form.zip_code }}
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label required">City / Municipality</label>
          {{ form.city_municipality }}
        </div>

        <div class="col-md-6">
          <label class="form-label required">Province</label>
          {{ form.province }}
        </div>
      </div>
    </div>

    <!-- LICENSE INFORMATION -->
    <div class="section-box">
      <div class="section-title">Driver's License Information</div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label required">License Number</label>
          {{ form.license_number }}
        </div>

        <div class="col-md-4">
          <label class="form-label required">License Expiry</label>
          {{ form.license_expiry }}
        </div>

        <div class="col-md-4">
          <label class="form-label required">License Type</label>
          {{ form.license_type }}
        </div>
      </div>
    </div>

    <!-- EMERGENCY CONTACT -->
    <div class="section-box">
      <div class="section-title">Emergency Contact</div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label required">Contact Name</label>
          {{ form.emergency_contact_name }}
        </div>

        <div class="col-md-4">
          <label class="form-label required">Contact Number</label>
          {{ form.emergency_contact_number }}
        </div>

        <div class="col-md-4">
          <label class="form-label">Relationship</label>
          {{ form.emergency_contact_relationship }}
        </div>
      </div>
    </div>

    <div class="d-flex">
        <a href="{% url 'accounts:staff_dashboard' %}" 
          class="btn btn-outline-secondary me-auto"
          role="button"
          type="button">
          ← Back to Dashboard
        </a>

        <button type="submit" class="btn btn-success px-4 ms-auto">
            ✔ Register Driver
        </button>
    </div>
    </div>
  </form>

  <!-- OCR SECTION -->
  <hr class="my-4">

  <h6 class="mb-2"><i class="bi bi-camera"></i> Driver’s License OCR Scanner</h6>
  <p class="text-muted small">Capture a clear photo of the license to auto-fill the fields.</p>

  <div class="mb-3">
    <button id="openCameraBtn" class="btn btn-outline-success me-2">Open Camera</button>
    <button id="captureBtn" class="btn btn-primary me-2" disabled>Capture</button>
    <button id="closeCameraBtn" class="btn btn-danger" disabled>Close Camera</button>
  </div>

  <div id="cameraArea" class="mb-3" style="display:none;">
    <video id="cameraFeed" width="420" autoplay playsinline class="border rounded"></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="capturedImage" class="mt-3 border rounded" width="420" style="display:none;">
  </div>
</div>

<script>
const openCameraBtn = document.getElementById('openCameraBtn');
const closeCameraBtn = document.getElementById('closeCameraBtn');
const captureBtn = document.getElementById('captureBtn');
const video = document.getElementById('cameraFeed');
const canvas = document.getElementById('canvas');
const capturedImage = document.getElementById('capturedImage');
const cameraArea = document.getElementById('cameraArea');
let stream;

function getCSRF() {
  const el = document.querySelector('#driverForm [name=csrfmiddlewaretoken]');
  return el ? el.value : '';
}

openCameraBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    cameraArea.style.display = 'block';
    captureBtn.disabled = false;
    closeCameraBtn.disabled = false;
    openCameraBtn.disabled = true;
  } catch {
    alert('Camera access denied.');
  }
});

closeCameraBtn.addEventListener('click', () => {
  if (stream) stream.getTracks().forEach(track => track.stop());
  video.srcObject = null;
  cameraArea.style.display = 'none';
  captureBtn.disabled = true;
  closeCameraBtn.disabled = true;
  openCameraBtn.disabled = false;
});

captureBtn.addEventListener('click', async () => {
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth || 800;
  canvas.height = video.videoHeight || 600;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = canvas.toDataURL('image/png');

  capturedImage.src = imageData;
  capturedImage.style.display = 'block';

  try {
    const res = await fetch("{% url 'vehicles:ocr_process' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF()
      },
      body: JSON.stringify({ image_data: imageData })
    });

    const data = await res.json();

    if (data.error) {
      alert('OCR Error: ' + data.error);
    } else {
      for (const [key, value] of Object.entries(data)) {
        if (!value) continue;
        const input = document.getElementById('id_' + key);
        if (input) input.value = value;
      }
      alert('License scanned successfully.');
    }
  } catch (err) {
    alert('OCR request failed: ' + err);
  }
});
</script>

{% endblock %}
