{% extends 'base.html' %}
{% load static %}
{% block title %}Register Driver | TicketNow{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 bg-light sidebar p-3">
      {% include 'includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 p-4">
      <h3 class="mb-3"><i class="bi bi-person-plus"></i> Register Driver</h3>
      <p class="text-muted">Register a new driver with complete license and contact information.</p>

      {% if form.non_field_errors %}
      <div class="alert alert-danger">
        <strong>Form Error:</strong> {{ form.non_field_errors }}
      </div>
      {% endif %}

      <!-- Driver Registration Form -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data" action="{% url 'vehicles:register_driver' %}" id="driverForm">
            {% csrf_token %}

            <!-- Personal Information -->
            <div class="form-section border rounded p-3 mb-4 bg-light">
              <h5>Personal Information</h5>
              <div class="row">
                <div class="col-md-3 mb-3">
                  <label class="form-label fw-bold">First Name <span class="text-danger">*</span></label>
                  {% if form.first_name.errors %}
                    <div class="form-control border-danger">{{ form.first_name }}</div>
                    <div class="text-danger small mt-1">{{ form.first_name.errors|striptags }}</div>
                  {% else %}
                    {{ form.first_name }}
                  {% endif %}
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Middle Name</label>
                  {{ form.middle_name }}
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label fw-bold">Last Name <span class="text-danger">*</span></label>
                  {% if form.last_name.errors %}
                    <div class="form-control border-danger">{{ form.last_name }}</div>
                    <div class="text-danger small mt-1">{{ form.last_name.errors|striptags }}</div>
                  {% else %}
                    {{ form.last_name }}
                  {% endif %}
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Suffix</label>
                  {{ form.suffix }}
                </div>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">Birth Date <span class="text-danger">*</span></label>
                  {% if form.birth_date.errors %}
                    <div class="form-control border-danger">{{ form.birth_date }}</div>
                    <div class="text-danger small mt-1">{{ form.birth_date.errors|striptags }}</div>
                  {% else %}
                    {{ form.birth_date }}
                  {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Birth Place</label>
                  {{ form.birth_place }}
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">Blood Type <span class="text-danger">*</span></label>
                  {% if form.blood_type.errors %}
                    <div class="form-control border-danger">{{ form.blood_type }}</div>
                    <div class="text-danger small mt-1">{{ form.blood_type.errors|striptags }}</div>
                  {% else %}
                    {{ form.blood_type }}
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="form-section border rounded p-3 mb-4 bg-light">
              <h5>Contact Information</h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Mobile Number <span class="text-danger">*</span></label>
                  {% if form.mobile_number.errors %}
                    <div class="form-control border-danger">{{ form.mobile_number }}</div>
                    <div class="text-danger small mt-1">{{ form.mobile_number.errors|striptags }}</div>
                  {% else %}
                    {{ form.mobile_number }}
                  {% endif %}
                  <small class="text-muted">Format: +639171234567 or 09171234567</small>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Email Address <span class="text-danger">*</span></label>
                  {% if form.email.errors %}
                    <div class="form-control border-danger">{{ form.email }}</div>
                    <div class="text-danger small mt-1">{{ form.email.errors|striptags }}</div>
                  {% else %}
                    {{ form.email }}
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Address Information -->
            <div class="form-section border rounded p-3 mb-4 bg-light">
              <h5>Address Information</h5>
              <div class="row">
                <div class="col-md-3 mb-3">
                  <label class="form-label">House/Bldg No.</label>
                  {{ form.house_number }}
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Street <span class="text-danger">*</span></label>
                  {{ form.street }}
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label fw-bold">Barangay <span class="text-danger">*</span></label>
                  {% if form.barangay.errors %}
                    <div class="form-control border-danger">{{ form.barangay }}</div>
                    <div class="text-danger small mt-1">{{ form.barangay.errors|striptags }}</div>
                  {% else %}
                    {{ form.barangay }}
                  {% endif %}
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label fw-bold">ZIP Code <span class="text-danger">*</span></label>
                  {% if form.zip_code.errors %}
                    <div class="form-control border-danger">{{ form.zip_code }}</div>
                    <div class="text-danger small mt-1">{{ form.zip_code.errors|striptags }}</div>
                  {% else %}
                    {{ form.zip_code }}
                  {% endif %}
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">City/Municipality <span class="text-danger">*</span></label>
                  {% if form.city_municipality.errors %}
                    <div class="form-control border-danger">{{ form.city_municipality }}</div>
                    <div class="text-danger small mt-1">{{ form.city_municipality.errors|striptags }}</div>
                  {% else %}
                    {{ form.city_municipality }}
                  {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Province <span class="text-danger">*</span></label>
                  {% if form.province.errors %}
                    <div class="form-control border-danger">{{ form.province }}</div>
                    <div class="text-danger small mt-1">{{ form.province.errors|striptags }}</div>
                  {% else %}
                    {{ form.province }}
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- License Information -->
            <div class="form-section border rounded p-3 mb-4 bg-light">
              <h5>Driver’s License Information</h5>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">License Number <span class="text-danger">*</span></label>
                  {% if form.license_number.errors %}
                    <div class="form-control border-danger">{{ form.license_number }}</div>
                    <div class="text-danger small mt-1">{{ form.license_number.errors|striptags }}</div>
                  {% else %}
                    {{ form.license_number }}
                  {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">License Expiry <span class="text-danger">*</span></label>
                  {% if form.license_expiry.errors %}
                    <div class="form-control border-danger">{{ form.license_expiry }}</div>
                    <div class="text-danger small mt-1">{{ form.license_expiry.errors|striptags }}</div>
                  {% else %}
                    {{ form.license_expiry }}
                  {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">License Type <span class="text-danger">*</span></label>
                  {% if form.license_type.errors %}
                    <div class="form-control border-danger">{{ form.license_type }}</div>
                    <div class="text-danger small mt-1">{{ form.license_type.errors|striptags }}</div>
                  {% else %}
                    {{ form.license_type }}
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Emergency Contact -->
            <div class="form-section border rounded p-3 mb-4 bg-light">
              <h5>Emergency Contact</h5>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">Contact Name <span class="text-danger">*</span></label>
                  {% if form.emergency_contact_name.errors %}
                    <div class="form-control border-danger">{{ form.emergency_contact_name }}</div>
                    <div class="text-danger small mt-1">{{ form.emergency_contact_name.errors|striptags }}</div>
                  {% else %}
                    {{ form.emergency_contact_name }}
                  {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold">Contact Number <span class="text-danger">*</span></label>
                  {% if form.emergency_contact_number.errors %}
                    <div class="form-control border-danger">{{ form.emergency_contact_number }}</div>
                    <div class="text-danger small mt-1">{{ form.emergency_contact_number.errors|striptags }}</div>
                  {% else %}
                    {{ form.emergency_contact_number }}
                  {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Relationship</label>
                  {{ form.emergency_contact_relationship }}
                </div>
              </div>
            </div>

            <!-- Submit Buttons -->
            <div class="text-end">
              <button type="submit" class="btn btn-success btn-lg"><i class="bi bi-save"></i> Register Driver</button>
              <a href="{% url 'staff_dashboard' %}" class="btn btn-secondary btn-lg"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
            </div>
          </form>

          <hr>

          <!-- OCR SCANNER -->
          <h6 class="mb-2"><i class="bi bi-camera"></i> Driver’s License OCR Scanner</h6>
          <p class="text-muted small">Capture a clear photo of the license to auto-fill the fields below.</p>

          <div class="mb-3">
            <button id="openCameraBtn" class="btn btn-outline-success me-2">Open Camera</button>
            <button id="captureBtn" class="btn btn-primary me-2" disabled>Capture</button>
            <button id="closeCameraBtn" class="btn btn-danger" disabled>Close Camera</button>
          </div>

          <div id="cameraArea" class="mb-3" style="display:none;">
            <video id="cameraFeed" width="420" autoplay playsinline class="border rounded"></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <img id="capturedImage" class="mt-3 border rounded" width="420" style="display:none;">
          </div>
        </div>
      </div>

      <!-- Flash Messages -->
      {% if messages %}
      <div class="mt-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Auto-focus first invalid field -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const invalidField = document.querySelector('.border-danger input, .border-danger select');
  if (invalidField) invalidField.focus();
});
</script>

<!-- ✅ OCR JavaScript -->
<script>
const openCameraBtn = document.getElementById('openCameraBtn');
const closeCameraBtn = document.getElementById('closeCameraBtn');
const captureBtn = document.getElementById('captureBtn');
const video = document.getElementById('cameraFeed');
const canvas = document.getElementById('canvas');
const capturedImage = document.getElementById('capturedImage');
const cameraArea = document.getElementById('cameraArea');
let stream;

function getCSRF() {
  const el = document.querySelector('#driverForm [name=csrfmiddlewaretoken]');
  return el ? el.value : '';
}

openCameraBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    cameraArea.style.display = 'block';
    captureBtn.disabled = false;
    closeCameraBtn.disabled = false;
    openCameraBtn.disabled = true;
  } catch {
    alert('Camera access denied or unavailable.');
  }
});

closeCameraBtn.addEventListener('click', () => {
  if (stream) stream.getTracks().forEach(track => track.stop());
  video.srcObject = null;
  cameraArea.style.display = 'none';
  captureBtn.disabled = true;
  closeCameraBtn.disabled = true;
  openCameraBtn.disabled = false;
});

captureBtn.addEventListener('click', async () => {
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth || 800;
  canvas.height = video.videoHeight || 600;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = canvas.toDataURL('image/png');

  capturedImage.src = imageData;
  capturedImage.style.display = 'block';

  try {
    const res = await fetch("{% url 'vehicles:ocr_process' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF()
      },
      body: JSON.stringify({ image_data: imageData })
    });
    const data = await res.json();
    if (data.error) alert('❌ OCR Error: ' + data.error);
    else {
      for (const [key, value] of Object.entries(data)) {
        if (!value) continue;
        const input = document.getElementById('id_' + key);
        if (input) input.value = value;
      }
      alert('✅ License scanned successfully — fields updated.');
    }
  } catch (err) {
    alert('❌ OCR request failed: ' + err);
  }
});
</script>
{% endblock %}
