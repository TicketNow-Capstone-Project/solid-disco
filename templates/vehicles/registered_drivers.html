{% extends "base.html" %}
{% load static %}

{% block title %}Registered Drivers | RDFS{% endblock %}

{% block content %}

<style>
/* =====================================================
   RDFS – REGISTERED DRIVERS (MATCHED TO VEHICLES)
===================================================== */
.rdfs-drivers-scope{
  --rdfs-blue:#112666;
  --rdfs-blue-dark:#0c1c4a;
  --rdfs-accent:#2563eb;
  --rdfs-soft:#e8f4fd;

  --rdfs-text:#0f172a;
  --rdfs-muted:#64748b;

  --gray-100:#f7fafc;
  --gray-200:#edf2f7;
  --gray-300:#e2e8f0;

  --shadow-sm:0 1px 3px rgba(0,0,0,.08);
  --shadow-md:0 8px 18px rgba(0,0,0,.12);

  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
  color:var(--rdfs-text);
}

/* HEADER */
.rdfs-drivers-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:1rem;
  margin-bottom:1.25rem;
}

.rdfs-drivers-title{
  font-weight:800;
  color:var(--rdfs-blue-dark);
}

.rdfs-drivers-subtitle{
  font-size:.9rem;
  color:var(--rdfs-muted);
}

/* RETURN BUTTON – SAME AS VEHICLES */
.rdfs-drivers-back{
  border-radius:999px;
  font-weight:600;
  background:#fff;
  color:var(--rdfs-blue-dark);
  border:1.5px solid var(--rdfs-blue);
  white-space:nowrap;
}

.rdfs-drivers-back:hover{
  background:var(--rdfs-soft);
}

/* SEARCH BAR */
.rdfs-drivers-search-wrap{
  display:flex;
  justify-content:flex-end;
  margin-bottom:1rem;
}

.rdfs-drivers-search{
  position:relative;
  width:380px;
}

.rdfs-drivers-search-icon{
  position:absolute;
  left:16px;
  top:50%;
  transform:translateY(-50%);
  color:var(--rdfs-muted);
  font-size:.95rem;
}

.rdfs-drivers-search input{
  height:46px;
  width:100%;
  padding-left:44px;
  padding-right:86px;
  border-radius:999px;
  border:1.5px solid var(--gray-300);
  background:var(--gray-100);
  font-size:.9rem;
  transition:.2s ease;
}

.rdfs-drivers-search input::placeholder{
  color:var(--rdfs-muted);
}

.rdfs-drivers-search input:focus{
  outline:none;
  background:#fff;
  border-color:var(--rdfs-accent);
  box-shadow:0 0 0 4px rgba(37,99,235,.15);
}

.rdfs-drivers-search button{
  position:absolute;
  right:6px;
  top:50%;
  transform:translateY(-50%);
  height:34px;
  padding:0 16px;
  border-radius:999px;
  font-weight:700;
  font-size:.8rem;
  background:linear-gradient(135deg,var(--rdfs-accent),var(--rdfs-blue));
  border:none;
  color:#fff;
}

/* CARD */
.rdfs-drivers-card{
  border-radius:18px;
  box-shadow:var(--shadow-md);
  border:1px solid var(--gray-200);
}

/* TABLE */
.rdfs-drivers-table th{
  color:var(--rdfs-blue-dark);
  font-weight:700;
  white-space:nowrap;
}

.rdfs-drivers-table td{
  vertical-align:middle;
  font-size:.9rem;
}

/* BADGE */
.rdfs-drivers-badge{
  background:var(--rdfs-soft);
  color:var(--rdfs-blue);
  font-weight:600;
  padding:.35rem .65rem;
  border-radius:999px;
  font-size:.75rem;
}
</style>

<div class="rdfs-drivers-scope p-4">

  <!-- HEADER -->
  <div class="rdfs-drivers-header">
    <div>
      <h3 class="rdfs-drivers-title mb-1">
        <i class="bi bi-people-fill me-2"></i>
        Registered Drivers
      </h3>
      <p class="rdfs-drivers-subtitle mb-0">
        View, search, and manage registered drivers in the system.
      </p>
    </div>

    <a href="{% url 'accounts:staff_dashboard' %}"
       class="btn rdfs-drivers-back">
      <i class="bi bi-arrow-left-circle me-1"></i>
      Return to Dashboard
    </a>
  </div>

  <!-- SEARCH -->
  <div class="rdfs-drivers-search-wrap">
    <form method="get" class="rdfs-drivers-search" role="search">
      <i class="bi bi-search rdfs-drivers-search-icon"></i>
      <input
        type="text"
        name="q"
        placeholder="Search by name, license, or contact…"
        value="{{ request.GET.q }}"
      />
      <button type="submit">Search</button>
    </form>
  </div>

  <!-- MESSAGES -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- TABLE -->
  <div class="card rdfs-drivers-card">
    <div class="card-body table-responsive">

      {% if page_obj %}
      <table class="table table-hover table-bordered align-middle rdfs-drivers-table mb-0">
        <thead>
          <tr>
            <th>#</th>
            <th>Full Name</th>
            <th>License No.</th>
            <th>Type</th>
            <th>Expiry</th>
            <th>Contact</th>
            <th>Blood Type</th>
            <th>Email</th>
            <th>Registered</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for driver in page_obj %}
          <tr>
            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td><strong>{{ driver.first_name }} {{ driver.middle_name|default:"" }} {{ driver.last_name }}</strong></td>
            <td>{{ driver.license_number }}</td>
            <td><span class="rdfs-drivers-badge">{{ driver.license_type }}</span></td>
            <td>{{ driver.license_expiry|date:"M d, Y"|default:"N/A" }}</td>
            <td>{{ driver.mobile_number }}</td>
            <td>{{ driver.blood_type|default:"N/A" }}</td>
            <td>{{ driver.email }}</td>
            <td>{{ driver.created_at|date:"M d, Y" }}</td>
            <td>
              {% if user.is_superuser or user.role == 'admin' %}
                <button class="btn btn-danger btn-sm btn-delete-item"
                        data-url="{% url 'vehicles:delete_driver' driver.id %}"
                        data-type="Driver">
                  <i class="bi bi-trash-fill me-1"></i> Delete
                </button>
              {% else %}
                <span class="text-muted">No Action</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="text-center text-muted">No drivers registered yet.</p>
      {% endif %}

    </div>
  </div>

</div>


<script>
/* DELETE HANDLER – unchanged, safe */
document.querySelectorAll('.btn-delete-item').forEach(btn=>{
  btn.addEventListener('click',function(){
    const url=this.dataset.url;
    const type=this.dataset.type||'Item';
    if(confirm(`Are you sure you want to delete this ${type}?`)){
      fetch(url,{
        method:'POST',
        headers:{'X-CSRFToken':'{{ csrf_token }}'}
      })
      .then(r=>r.json())
      .then(d=>{
        if(d.success){
          alert(`${type} deleted successfully.`);
          location.reload();
        }else{
          alert(`❌ Failed to delete ${type}`);
        }
      })
      .catch(()=>alert(`❌ Error deleting ${type}`));
    }
  });
});
</script>

{% endblock %}
