{% extends "base.html" %}
{% load static %}

{% block title %}Registered Drivers | RDFS{% endblock %}

{% block content %}

<style>
/* =====================================================
   RDFS – REGISTERED DRIVERS (SCOPED STYLES ONLY)
   Prefix: rdfs-drivers-
===================================================== */
.rdfs-drivers-scope{
  --rdfs-blue:#112666;
  --rdfs-blue-dark:#0c1c4a;
  --rdfs-accent:#2563eb;
  --rdfs-soft:#e8f4fd;

  --rdfs-text:#0f172a;
  --rdfs-muted:#64748b;

  --gray-100:#f7fafc;
  --gray-200:#edf2f7;
  --gray-300:#e2e8f0;

  --shadow-sm:0 1px 3px rgba(0,0,0,.08);
  --shadow-md:0 8px 18px rgba(0,0,0,.12);

  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
  color:var(--rdfs-text);
}

/* HEADER */
.rdfs-drivers-title{
  font-weight:700;
  color:var(--rdfs-blue);
}

/* SEARCH */
.rdfs-drivers-search{
  display:flex;
}

.rdfs-drivers-search input{
  height:48px;
  border-radius:999px;
  border:1.5px solid var(--gray-300);
}

.rdfs-drivers-search input:focus{
  border-color:var(--rdfs-accent);
  box-shadow:0 0 0 3px rgba(37,99,235,.18);
}

.rdfs-drivers-search button{
  border-radius:999px;
  font-weight:700;
  background:linear-gradient(135deg,var(--rdfs-accent),var(--rdfs-blue));
  border:none;
  color:#fff;
}

/* CARD */
.rdfs-drivers-card{
  border-radius:18px;
  box-shadow:var(--shadow-md);
  border:1px solid var(--gray-200);
}

/* TABLE */
.rdfs-drivers-table thead{
  background:var(--gray-100);
}

.rdfs-drivers-table th{
  color:var(--rdfs-blue-dark);
  font-weight:700;
  white-space:nowrap;
}

.rdfs-drivers-table td{
  vertical-align:middle;
  font-size:.9rem;
}

/* BADGE */
.rdfs-drivers-badge{
  background:var(--rdfs-soft);
  color:var(--rdfs-blue);
  font-weight:600;
  padding:.35rem .65rem;
  border-radius:999px;
  font-size:.75rem;
}

/* ACTION BUTTONS */
.rdfs-drivers-delete{
  border-radius:999px;
  font-weight:600;
}

.rdfs-drivers-back{
  border-radius:999px;
  font-weight:600;
}

/* PAGINATION */
.rdfs-drivers-pagination .page-link{
  border-radius:999px;
  margin:0 2px;
  color:var(--rdfs-blue);
}

.rdfs-drivers-pagination .active .page-link{
  background:var(--rdfs-blue);
  border-color:var(--rdfs-blue);
}
</style>

<div class="rdfs-drivers-scope p-4">

  <h3 class="rdfs-drivers-title mb-2">
    <i class="bi bi-people-fill me-2"></i>
    Registered Drivers
  </h3>
  <p class="text-muted mb-4">
    View, search, and manage registered drivers in the system.
  </p>

  <!-- SEARCH -->
  <form method="get" class="rdfs-drivers-search mb-4" role="search">
    <input
      type="text"
      name="q"
      class="form-control me-2"
      placeholder="Search driver by name, license number, or contact..."
      value="{{ request.GET.q }}"
    />
    <button type="submit">
      <i class="bi bi-search-heart-fill me-1"></i>
      Search
    </button>
  </form>

  <!-- MESSAGES -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- TABLE -->
  <div class="card rdfs-drivers-card">
    <div class="card-body table-responsive">

      {% if page_obj %}
      <table class="table table-hover table-bordered align-middle rdfs-drivers-table mb-0">
        <thead>
          <tr>
            <th>#</th>
            <th>Full Name</th>
            <th>License No.</th>
            <th>Type</th>
            <th>Expiry</th>
            <th>Contact</th>
            <th>Blood Type</th>
            <th>Email</th>
            <th>Registered</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for driver in page_obj %}
          <tr>
            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td>
              <strong>
                {{ driver.first_name }}
                {{ driver.middle_name|default:"" }}
                {{ driver.last_name }}
              </strong>
            </td>
            <td>{{ driver.license_number }}</td>
            <td>
              <span class="rdfs-drivers-badge">
                {{ driver.license_type }}
              </span>
            </td>
            <td>
              {% if driver.license_expiry %}
                {{ driver.license_expiry|date:"M d, Y" }}
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>{{ driver.mobile_number }}</td>
            <td>{{ driver.blood_type|default:"N/A" }}</td>
            <td>{{ driver.email }}</td>
            <td>{{ driver.created_at|date:"M d, Y" }}</td>
            <td>
              {% if user.is_superuser or user.role == 'admin' %}
                <button class="btn btn-danger btn-sm rdfs-drivers-delete btn-delete-item"
                        data-url="{% url 'vehicles:delete_driver' driver.id %}"
                        data-type="Driver">
                  <i class="bi bi-trash-fill me-1"></i>
                  Delete
                </button>
              {% else %}
                <span class="text-muted">No Action</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-center text-muted py-3">
              No drivers found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="text-center text-muted">No drivers registered yet.</p>
      {% endif %}

    </div>

    <!-- PAGINATION -->
    {% if page_obj.has_other_pages %}
    <div class="card-footer bg-light d-flex justify-content-between align-items-center">
      <div>
        Showing {{ page_obj.start_index }}–{{ page_obj.end_index }}
        of {{ page_obj.paginator.count }} drivers
      </div>
      <nav class="rdfs-drivers-pagination">
        <ul class="pagination mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?q={{ request.GET.q }}&page={{ page_obj.previous_page_number }}">&laquo; Prev</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo; Prev</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
              <li class="page-item">
                <a class="page-link" href="?q={{ request.GET.q }}&page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?q={{ request.GET.q }}&page={{ page_obj.next_page_number }}">Next &raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next &raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>

  <!-- BACK -->
  <div class="mt-4 text-end">
    <a href="{% url 'accounts:staff_dashboard' %}" class="btn btn-secondary btn-lg rdfs-drivers-back">
      <i class="bi bi-arrow-left-circle-fill me-1"></i>
      Back to Dashboard
    </a>
  </div>

</div>

<script>
/* DELETE HANDLER – unchanged, safe */
document.querySelectorAll('.btn-delete-item').forEach(btn=>{
  btn.addEventListener('click',function(){
    const url=this.dataset.url;
    const type=this.dataset.type||'Item';
    if(confirm(`Are you sure you want to delete this ${type}?`)){
      fetch(url,{
        method:'POST',
        headers:{'X-CSRFToken':'{{ csrf_token }}'}
      })
      .then(r=>r.json())
      .then(d=>{
        if(d.success){
          alert(`${type} deleted successfully.`);
          location.reload();
        }else{
          alert(`❌ Failed to delete ${type}`);
        }
      })
      .catch(()=>alert(`❌ Error deleting ${type}`));
    }
  });
});
</script>

{% endblock %}
