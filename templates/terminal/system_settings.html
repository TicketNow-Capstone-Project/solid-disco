{% extends 'base.html' %}
{% load static %}
{% block title %}System Settings | TicketNow{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 bg-light sidebar p-3">
      {% include 'includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 p-4">
      <h3><i class="bi bi-gear"></i> System Settings</h3>
      <p class="text-muted">Manage terminal-wide configurations such as entry fee.</p>

      <!-- ðŸŸ© Current Fee Display -->
      <div class="alert alert-info d-flex align-items-center justify-content-between">
        <div>
          <i class="bi bi-cash-stack me-2"></i>
          <strong>Current Terminal Fee:</strong> â‚±{{ form.instance.terminal_fee }}
        </div>
        <span class="text-muted small">Last updated: {{ form.instance.updated_at|date:"M d, Y H:i" }}</span>
      </div>

      <!-- Flash Messages -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Settings Card -->
      <div class="card shadow-sm border-0 mt-3">
        <div class="card-body">
          <form method="POST" id="settingsForm" novalidate>
            {% csrf_token %}

            <!-- Terminal Fee -->
            <div class="mb-3">
              <label class="form-label fw-bold">New Terminal Entry Fee (â‚±)</label>
              {{ form.terminal_fee }}
              {% if form.terminal_fee.errors %}
                <div class="text-danger small mt-1">{{ form.terminal_fee.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- Minimum Deposit -->
            <div class="mb-3">
              <label class="form-label fw-bold">Minimum Deposit Required (â‚±)</label>
              {{ form.min_deposit_amount }}
              {% if form.min_deposit_amount.errors %}
                <div class="text-danger small mt-1">{{ form.min_deposit_amount.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- Entry Cooldown -->
            <div class="mb-3">
              <label class="form-label fw-bold">Entry Cooldown (minutes)</label>
              {{ form.entry_cooldown_minutes }}
              {% if form.entry_cooldown_minutes.errors %}
                <div class="text-danger small mt-1">{{ form.entry_cooldown_minutes.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- ðŸŸ© NEW FIELD: Vehicle Stay Duration -->
            <div class="mb-3">
              <label class="form-label fw-bold">Vehicle Stay Duration (minutes before departure)</label>
              {{ form.departure_duration_minutes }}
              {% if form.departure_duration_minutes.errors %}
                <div class="text-danger small mt-1">{{ form.departure_duration_minutes.errors|striptags }}</div>
              {% endif %}
              <small class="form-text text-muted">
                Determines how long a vehicle can stay in the terminal after entry before being marked as departed.
              </small>
            </div>

            <!-- Theme -->
            <div class="mb-3">
              <label class="form-label fw-bold">System Theme</label>
              {{ form.theme_preference }}
              {% if form.theme_preference.errors %}
                <div class="text-danger small mt-1">{{ form.theme_preference.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- Buttons -->
            <div class="text-end">
              <button type="button" class="btn btn-success" id="openConfirmModal">
                <i class="bi bi-save"></i> Save Settings
              </button>
              <a href="{% url 'staff_dashboard' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ðŸŸ© Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="confirmModalLabel"><i class="bi bi-exclamation-triangle-fill"></i> Confirm Update</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="fw-semibold">Are you sure you want to update the system settings?</p>
        <p class="text-muted small mb-0">This will immediately apply the new settings for all future vehicle entries.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmSaveBtn">
          <i class="bi bi-check-circle"></i> Yes, Update
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ðŸŸ¦ Scripts -->
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const openConfirmBtn = document.getElementById("openConfirmModal");
  const confirmModal = new bootstrap.Modal(document.getElementById("confirmModal"));
  const confirmSaveBtn = document.getElementById("confirmSaveBtn");
  const form = document.getElementById("settingsForm");

  // Open confirmation modal
  openConfirmBtn.addEventListener("click", () => {
    confirmModal.show();
  });

  // When confirmed, submit the form
  confirmSaveBtn.addEventListener("click", () => {
    confirmModal.hide();
    form.submit();
  });
});
</script>
{% endblock %}
