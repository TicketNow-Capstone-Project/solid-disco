{% extends "base.html" %}
{% load static %}

{% block title %}QR Exit Validation | RDFS{% endblock %}

{% block content %}

<style>
/* =====================================================
   RDFS ‚Äì QR EXIT VALIDATION (SCOPED)
   Prefix: rdfs-qr-exit-
===================================================== */
.rdfs-qr-exit-scope{
  --rdfs-blue:#112666;
  --rdfs-danger:#dc3545;
  --rdfs-success:#198754;
  --rdfs-muted:#64748b;

  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
}

/* CARD */
.rdfs-qr-exit-card{
  border-radius:18px;
}

/* FEEDBACK */
.rdfs-qr-exit-feedback{
  font-weight:600;
}

/* FLASH ANIMATIONS */
@keyframes rdfsFlashGreen{
  0%{background-color:#19875420;}
  50%{background-color:#19875480;}
  100%{background-color:transparent;}
}
@keyframes rdfsFlashRed{
  0%{background-color:#dc354520;}
  50%{background-color:#dc354580;}
  100%{background-color:transparent;}
}

.rdfs-qr-exit-flash-success{
  animation:rdfsFlashGreen 1.5s ease;
}
.rdfs-qr-exit-flash-error{
  animation:rdfsFlashRed 1.5s ease;
}
</style>

<div class="p-4 rdfs-qr-exit-scope">

  <!-- INFO -->
  <div class="alert alert-warning text-start small">
    <strong>Exit Validation:</strong>
    Scan a vehicle‚Äôs QR to mark it as departed.
  </div>

  <div class="card shadow-sm border-0 mt-4 rdfs-qr-exit-card">
    <div class="card-header bg-danger text-white">
      <h5 class="mb-0">
        <i class="bi bi-qr-code me-2"></i>
        QR Exit Validation
      </h5>
    </div>

    <div class="card-body text-center">

      <p class="text-muted mb-3">
        Use the camera to scan a vehicle‚Äôs QR code.
        The system will automatically mark it as
        <strong>departed</strong> if currently inside the terminal.
      </p>

      <!-- QR SCANNER -->
      <div id="rdfsQrReader"
           style="width:100%;max-width:400px;margin:auto;"></div>

      <!-- FEEDBACK -->
      <div id="rdfsQrFeedback"
           class="alert d-none mt-3 text-center rdfs-qr-exit-feedback"
           role="alert"></div>

      <div class="mt-3">
        <a hx-get="{% url 'terminal:terminal_queue' %}"
           hx-target="#main-content"
           hx-swap="innerHTML transition:true"
           class="btn btn-outline-danger btn-sm">
          <i class="bi bi-list-check me-1"></i>
          View Terminal Queue
        </a>
      </div>

      <!-- CSRF -->
      <form style="display:none;">{% csrf_token %}</form>

      <!-- SCAN LOG -->
      <div id="rdfsQrScanLog"></div>

    </div>
  </div>
</div>

<!-- QR LIB -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
/* =====================================================
   RDFS ‚Äì QR EXIT SCANNER LOGIC
===================================================== */

// üîä Sounds
const rdfsQrSuccessBeep = new Audio(
  "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
);
const rdfsQrErrorBeep = new Audio(
  "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
);

// üßæ Last 5 scans
let rdfsQrRecentScans = [];
let rdfsQrScanningPaused = false;

/* FEEDBACK */
function rdfsShowQrFeedback(message, kind="info"){
  const fb=document.getElementById("rdfsQrFeedback");
  fb.className="alert mt-3 text-center rdfs-qr-exit-feedback";
  fb.textContent=message;
  fb.classList.remove("d-none","alert-success","alert-danger","alert-warning","alert-info");

  if(kind==="success") fb.classList.add("alert-success");
  else if(kind==="danger") fb.classList.add("alert-danger");
  else fb.classList.add("alert-info");

  const scope=document.querySelector(".rdfs-qr-exit-scope");
  scope.classList.remove("rdfs-qr-exit-flash-success","rdfs-qr-exit-flash-error");

  if(kind==="success"){
    scope.classList.add("rdfs-qr-exit-flash-success");
    rdfsQrSuccessBeep.play().catch(()=>{});
  }else if(kind==="danger"){
    scope.classList.add("rdfs-qr-exit-flash-error");
    rdfsQrErrorBeep.play().catch(()=>{});
  }
}

/* POST QR */
async function rdfsPostQrCode(qrCode){
  try{
    const res=await fetch("{% url 'terminal:qr_exit_validation' %}",{
      method:"POST",
      headers:{
        "X-CSRFToken":document.querySelector('[name=csrfmiddlewaretoken]').value,
        "X-Requested-With":"XMLHttpRequest"
      },
      body:new URLSearchParams({qr_code:qrCode})
    });

    const data=await res.json();
    const balanceTxt=data.balance!==undefined
      ? ` (Remaining Balance: ‚Ç±${parseFloat(data.balance).toFixed(2)})`
      : "";

    const msg=data.message+balanceTxt;

    if(data.status==="success"){
      rdfsShowQrFeedback(msg,"success");
      rdfsAddQrLog("‚úÖ Departed",msg,"success");
      rdfsPauseQrScan(4000);
    }else{
      rdfsShowQrFeedback(msg,"danger");
      rdfsAddQrLog("‚ùå Failed",msg,"danger");
      rdfsPauseQrScan(3000);
    }
  }catch{
    rdfsShowQrFeedback("‚ö†Ô∏è Network error ‚Äî please check your connection.","danger");
    rdfsAddQrLog("‚ö†Ô∏è Error","Network failure","danger");
  }
}

/* PAUSE SCAN */
function rdfsPauseQrScan(ms){
  rdfsQrScanningPaused=true;
  setTimeout(()=>{
    rdfsQrScanningPaused=false;
    rdfsShowQrFeedback("üì∑ Ready for next scan...","info");
  },ms);
}

/* LOG */
function rdfsAddQrLog(status,message,type){
  const time=new Date().toLocaleTimeString();
  if(rdfsQrRecentScans.length>=5) rdfsQrRecentScans.shift();
  rdfsQrRecentScans.push({status,message,time,type});
  rdfsRenderQrLogs();
}

/* RENDER LOG */
function rdfsRenderQrLogs(){
  const el=document.getElementById("rdfsQrScanLog");
  el.innerHTML=`
    <table class="table table-sm table-hover align-middle mt-3 mb-0">
      <thead class="table-light">
        <tr><th>Time</th><th>Status</th><th>Message</th></tr>
      </thead>
      <tbody>
        ${rdfsQrRecentScans.map(s=>`
          <tr class="${s.type==="success"?"table-success":"table-danger"}">
            <td>${s.time}</td>
            <td>${s.status}</td>
            <td>${s.message}</td>
          </tr>
        `).reverse().join("")}
      </tbody>
    </table>
  `;
}

/* INIT SCANNER */
document.addEventListener("DOMContentLoaded",()=>{
  const qr=new Html5Qrcode("rdfsQrReader");
  let lastScan="";

  qr.start(
    {facingMode:"environment"},
    {fps:10,qrbox:{width:250,height:250}},
    text=>{
      if(rdfsQrScanningPaused||text===lastScan) return;
      lastScan=text;
      rdfsPostQrCode(text);
    },
    ()=>{}
  ).catch(err=>{
    rdfsShowQrFeedback("‚ùå Failed to access camera: "+err,"danger");
  });
});
</script>

{% endblock %}
