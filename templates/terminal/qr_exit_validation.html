{% extends "base.html" %}
{% load static %}

{% block title %}QR Exit Validation | TicketNow{% endblock %}

{% block content %}
<div class="p-4">
  <div class="alert alert-warning text-start small">
    <strong>Exit Validation:</strong> Scan a vehicle‚Äôs QR to mark it as departed.
  </div>

  <div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-danger text-white">
      <h5 class="mb-0"><i class="bi bi-qr-code-scan me-2"></i> QR Exit Validation</h5>
    </div>

    <div class="card-body text-center">
      <p class="text-muted mb-3">
        Use the camera to scan a vehicle‚Äôs QR code. The system will automatically
        mark it as <strong>departed</strong> if currently inside the terminal.
      </p>

      <!-- üü© QR Scanner -->
      <div id="qr-reader" style="width:100%; max-width:400px; margin:auto;"></div>

      <!-- ‚úÖ Live feedback -->
      <div id="feedback" class="alert d-none mt-3 fw-semibold text-center" role="alert"></div>

      <div class="mt-3">
        <a hx-get="{% url 'terminal:terminal_queue' %}" 
           hx-target="#main-content" 
           hx-swap="innerHTML transition:true"
           class="btn btn-outline-danger btn-sm">
          <i class="bi bi-list-ul me-1"></i> View Terminal Queue
        </a>
      </div>

      <!-- Hidden CSRF token -->
      <form style="display:none;">{% csrf_token %}</form>
    </div>
  </div>
</div>

<!-- üü¶ html5-qrcode CDN -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
/* =====================================================
   üî¥ QR Exit Scanner with Real-time Feedback & Logs
   ===================================================== */

// üîä Sounds
const successBeep = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const errorBeep = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

// üßæ Last 5 scan records
let recentScans = [];

/**
 * üí¨ Display feedback on screen + visual flash
 */
function showFeedback(message, kind = "info") {
  const fb = document.getElementById("feedback");
  fb.className = "alert mt-3 fw-semibold text-center";
  fb.textContent = message;
  fb.classList.remove("d-none", "alert-success", "alert-danger", "alert-warning", "alert-info");

  if (kind === "success") fb.classList.add("alert-success");
  else if (kind === "danger") fb.classList.add("alert-danger");
  else fb.classList.add("alert-info");

  // üí° Flash background
  const body = document.body;
  body.classList.remove("flash-success", "flash-error");
  if (kind === "success") {
    body.classList.add("flash-success");
    successBeep.play().catch(() => {});
  } else if (kind === "danger") {
    body.classList.add("flash-error");
    errorBeep.play().catch(() => {});
  }
}

/**
 * üì¨ Send QR to backend for exit validation
 */
async function postQRCode(qrCode) {
  try {
    const response = await fetch("{% url 'terminal:qr_exit_validation' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: new URLSearchParams({ qr_code: qrCode }),
    });

    const data = await response.json();
    let balanceText = data.balance !== undefined
      ? ` (Remaining Balance: ‚Ç±${parseFloat(data.balance).toFixed(2)})`
      : "";

    const message = data.message + balanceText;

    if (data.status === "success") {
      showFeedback(message, "success");
      addToLog("‚úÖ Departed", message, "success");
      pauseScanTemporarily(4000);
    } else {
      showFeedback(message, "danger");
      addToLog("‚ùå Failed", message, "danger");
      pauseScanTemporarily(3000);
    }
  } catch (err) {
    showFeedback("‚ö†Ô∏è Network error ‚Äî please check your connection.", "danger");
    addToLog("‚ö†Ô∏è Error", "Network failure", "danger");
  }
}

/**
 * ‚è∏Ô∏è Prevent duplicate scans temporarily
 */
function pauseScanTemporarily(ms) {
  scanningPaused = true;
  setTimeout(() => {
    scanningPaused = false;
    document.body.classList.remove("flash-success", "flash-error");
    showFeedback("üì∑ Ready for next scan...", "info");
  }, ms);
}

/**
 * üßæ Add a new scan record to log table
 */
function addToLog(status, message, type) {
  const time = new Date().toLocaleTimeString();
  if (recentScans.length >= 5) recentScans.shift();
  recentScans.push({ status, message, time, type });
  renderLogs();
}

/**
 * üñãÔ∏è Render last 5 scans table
 */
function renderLogs() {
  const logContainer = document.getElementById("scanLog");
  if (!logContainer) return;
  logContainer.innerHTML = `
    <table class="table table-sm table-hover align-middle mt-3 mb-0">
      <thead class="table-light"><tr><th>Time</th><th>Status</th><th>Message</th></tr></thead>
      <tbody>
        ${recentScans
          .map(
            s => `
              <tr class="${s.type === 'success' ? 'table-success' : 'table-danger'}">
                <td>${s.time}</td>
                <td>${s.status}</td>
                <td>${s.message}</td>
              </tr>
            `
          )
          .reverse()
          .join("")}
      </tbody>
    </table>
  `;
}

/**
 * üì∏ Initialize QR scanner
 */
document.addEventListener("DOMContentLoaded", function() {
  const html5QrCode = new Html5Qrcode("qr-reader");
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };
  let lastScanned = "";
  scanningPaused = false;

  html5QrCode.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      if (scanningPaused || decodedText === lastScanned) return;
      lastScanned = decodedText;
      postQRCode(decodedText);
    },
    (errorMessage) => {}
  ).catch(err => {
    showFeedback("‚ùå Failed to access camera: " + err, "danger");
  });
});
</script>

<style>
/* üåà Flash background animation */
@keyframes flash-green {
  0% { background-color: #19875420; }
  50% { background-color: #19875480; }
  100% { background-color: transparent; }
}
@keyframes flash-red {
  0% { background-color: #dc354520; }
  50% { background-color: #dc354580; }
  100% { background-color: transparent; }
}
.flash-success { animation: flash-green 1.5s ease; }
.flash-error { animation: flash-red 1.5s ease; }
</style>

{% endblock %}
