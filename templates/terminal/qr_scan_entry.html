{% extends "base.html" %}
{% load static %}

{% block title %}QR Scan Entry & Departure | TicketNow{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Top Info Boxes styled like updated UI -->
  <div class="row g-3 mb-4">
    <div class="col-4">
      <div class="p-3 bg-light rounded text-center shadow-sm">
        <h6 class="text-muted mb-1">Current Fee</h6>
        <p class="fw-bold mb-0">‚Ç±{{ terminal_fee }}</p>
      </div>
    </div>
    <div class="col-4">
      <div class="p-3 bg-light rounded text-center shadow-sm">
        <h6 class="text-muted mb-1">Minimum Deposit</h6>
        <p class="fw-bold mb-0">‚Ç±{{ min_deposit }}</p>
      </div>
    </div>
    <div class="col-4">
      <div class="p-3 bg-light rounded text-center shadow-sm">
        <h6 class="text-muted mb-1">Cooldown</h6>
        <p class="fw-bold mb-0">{{ cooldown }} minute(s)</p>
      </div>
    </div>
  </div>

  <!-- Main UI Card -->
  <div class="card shadow border-0">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-qr-code-scan me-2"></i> QR Scan Entry & Departure Validation
      </h5>
    </div>

    <div class="card-body text-center">

      <p class="text-muted mb-3" style="font-size: 0.95rem;">
        Use the camera to scan a vehicle‚Äôs QR code. The system will automatically detect 
        whether it‚Äôs an <span class="text-success fw-bold">entry</span> or 
        <span class="text-warning fw-bold">departure</span>.
      </p>

      <!-- Scanner Box styled like updated UI -->
      <div id="qr-reader" 
           class="rounded mb-3"
           style="width:100%; max-width:400px; height:auto; margin:auto; background:#343a40;">
      </div>

      <!-- Feedback -->
      <div id="feedback" class="alert d-none mt-3 fw-semibold text-center"></div>

      <!-- View queue (kept backend logic & HTMX intact) -->
      <div class="mt-3">
        <a hx-get="{% url 'terminal:terminal_queue' %}"
           hx-target="#main-content"
           hx-swap="innerHTML transition:true"
           class="btn btn-outline-primary btn-sm">
          <i class="bi bi-list-ul me-1"></i> View Terminal Queue
        </a>
      </div>

      <!-- Hidden CSRF Token -->
      <form style="display:none;">{% csrf_token %}</form>

      <!-- Logs container (preserved) -->
      <div id="scanLog" class="mt-4"></div>

    </div>
  </div>
</div>

<!-- html5-qrcode CDN -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<!-- JS (100% unchanged backend logic) -->
<script>
/* =====================================================
   üü¢ Real-Time QR Scanner with Logs & Balance Display
   ===================================================== */

const successBeep = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const errorBeep = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

let recentScans = [];

function showFeedback(message, kind = "info") {
  const fb = document.getElementById("feedback");
  fb.className = "alert mt-3 fw-semibold text-center";
  fb.textContent = message;
  fb.classList.remove("d-none", "alert-success", "alert-danger", "alert-warning", "alert-info");

  if (kind === "success") fb.classList.add("alert-success");
  else if (kind === "danger") fb.classList.add("alert-danger");
  else fb.classList.add("alert-info");

  const body = document.body;
  body.classList.remove("flash-success", "flash-error");
  if (kind === "success") {
    body.classList.add("flash-success");
    successBeep.play().catch(() => {});
  } else if (kind === "danger") {
    body.classList.add("flash-error");
    errorBeep.play().catch(() => {});
  }
}

async function postQRCode(qrCode) {
  try {
    const response = await fetch("{% url 'terminal:qr_scan_entry' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: new URLSearchParams({ qr_code: qrCode }),
    });

    const data = await response.json();
    let balanceText = data.balance !== undefined 
        ? ` (Remaining Balance: ‚Ç±${parseFloat(data.balance).toFixed(2)})`
        : "";

    const message = data.message + balanceText;

    if (data.status === "success") {
      showFeedback(message, "success");
      addToLog("‚úÖ Success", message, "success");
      pauseScanTemporarily(4000);
    } else {
      showFeedback(message, "danger");
      addToLog("‚ùå Failed", message, "danger");
      pauseScanTemporarily(3000);
    }
  } catch (err) {
    showFeedback("‚ö†Ô∏è Network error ‚Äî please check your connection.", "danger");
    addToLog("‚ö†Ô∏è Error", "Network failure", "danger");
  }
}

function pauseScanTemporarily(ms) {
  scanningPaused = true;
  setTimeout(() => {
    scanningPaused = false;
    document.body.classList.remove("flash-success", "flash-error");
    showFeedback("üì∑ Ready for next scan...", "info");
  }, ms);
}

function addToLog(status, message, type) {
  const time = new Date().toLocaleTimeString();
  if (recentScans.length >= 5) recentScans.shift();
  recentScans.push({ status, message, time, type });
  renderLogs();
}

function renderLogs() {
  const logContainer = document.getElementById("scanLog");
  if (!logContainer) return;
  logContainer.innerHTML = `
    <table class="table table-sm table-hover align-middle mt-3 mb-0">
      <thead class="table-light"><tr><th>Time</th><th>Status</th><th>Message</th></tr></thead>
      <tbody>
        ${recentScans
          .map(
            s => `
              <tr class="${s.type === 'success' ? 'table-success' : 'table-danger'}">
                <td>${s.time}</td>
                <td>${s.status}</td>
                <td>${s.message}</td>
              </tr>
            `
          )
          .reverse()
          .join("")}
      </tbody>
    </table>
  `;
}

document.addEventListener("DOMContentLoaded", function() {
  const html5QrCode = new Html5Qrcode("qr-reader");
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };
  let lastScanned = "";
  scanningPaused = false;

  html5QrCode.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      if (scanningPaused || decodedText === lastScanned) return;
      lastScanned = decodedText;
      postQRCode(decodedText);
    },
    () => {}
  ).catch(err => {
    showFeedback("‚ùå Failed to access camera: " + err, "danger");
  });
});
</script>

<style>
@keyframes flash-green {
  0% { background-color: #19875420; }
  50% { background-color: #19875480; }
  100% { background-color: transparent; }
}
@keyframes flash-red {
  0% { background-color: #dc354520; }
  50% { background-color: #dc354580; }
  100% { background-color: transparent; }
}
.flash-success { animation: flash-green 1.5s ease; }
.flash-error { animation: flash-red 1.5s ease; }
</style>

{% endblock %}
