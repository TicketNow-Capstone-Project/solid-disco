{% extends "base.html" %}
{% load static %}

{% block title %}QR Scan Entry & Departure | RDFS{% endblock %}

{% block content %}

<style>
/* =====================================================
   RDFS ‚Äì QR ENTRY & DEPARTURE (SCOPED)
   Prefix: rdfs-qr-ed-
===================================================== */
.rdfs-qr-ed-scope{
  --rdfs-primary:#112666;
  --rdfs-success:#198754;
  --rdfs-warning:#f59e0b;
  --rdfs-danger:#dc3545;
  --rdfs-muted:#64748b;

  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
}

/* INFO CARDS */
.rdfs-qr-ed-info{
  background:#f8fafc;
  border-radius:12px;
}

/* MAIN CARD */
.rdfs-qr-ed-card{
  border-radius:18px;
}

/* SCANNER */
#rdfsQrEdReader{
  background:#343a40;
}

/* FEEDBACK */
.rdfs-qr-ed-feedback{
  font-weight:600;
}

/* FLASH EFFECT */
@keyframes rdfsQrEdFlashGreen{
  0%{background:#19875420;}
  50%{background:#19875480;}
  100%{background:transparent;}
}
@keyframes rdfsQrEdFlashRed{
  0%{background:#dc354520;}
  50%{background:#dc354580;}
  100%{background:transparent;}
}
.rdfs-qr-ed-flash-success{
  animation:rdfsQrEdFlashGreen 1.5s ease;
}
.rdfs-qr-ed-flash-error{
  animation:rdfsQrEdFlashRed 1.5s ease;
}
</style>

<div class="container py-4 rdfs-qr-ed-scope">

  <!-- TOP INFO -->
  <div class="row g-3 mb-4">
    <div class="col-4">
      <div class="p-3 text-center shadow-sm rdfs-qr-ed-info">
        <h6 class="text-muted mb-1">Current Fee</h6>
        <p class="fw-bold mb-0">‚Ç±{{ terminal_fee }}</p>
      </div>
    </div>
    <div class="col-4">
      <div class="p-3 text-center shadow-sm rdfs-qr-ed-info">
        <h6 class="text-muted mb-1">Minimum Deposit</h6>
        <p class="fw-bold mb-0">‚Ç±{{ min_deposit }}</p>
      </div>
    </div>
    <div class="col-4">
      <div class="p-3 text-center shadow-sm rdfs-qr-ed-info">
        <h6 class="text-muted mb-1">Cooldown</h6>
        <p class="fw-bold mb-0">{{ cooldown }} minute(s)</p>
      </div>
    </div>
  </div>

  <!-- MAIN CARD -->
  <div class="card shadow border-0 rdfs-qr-ed-card">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-qr-code me-2"></i>
        QR Scan Entry & Departure Validation
      </h5>
    </div>

    <div class="card-body text-center">

      <p class="text-muted mb-3" style="font-size:.95rem;">
        Scan a vehicle QR code. The system automatically detects
        <span class="fw-bold text-success">entry</span> or
        <span class="fw-bold text-warning">departure</span>.
      </p>

      <!-- SCANNER -->
      <div id="rdfsQrEdReader"
           class="rounded mb-3"
           style="width:100%;max-width:400px;margin:auto;">
      </div>

      <!-- FEEDBACK -->
      <div id="rdfsQrEdFeedback"
           class="alert d-none mt-3 text-center rdfs-qr-ed-feedback">
      </div>

      <!-- VIEW QUEUE -->
      <div class="mt-3">
        <a hx-get="{% url 'terminal:terminal_queue' %}"
           hx-target="#main-content"
           hx-swap="innerHTML transition:true"
           class="btn btn-outline-primary btn-sm">
          <i class="bi bi-list-check me-1"></i>
          View Terminal Queue
        </a>
      </div>

      <!-- CSRF -->
      <form style="display:none;">{% csrf_token %}</form>

      <!-- LOGS -->
      <div id="rdfsQrEdLog" class="mt-4"></div>

    </div>
  </div>
</div>

<!-- QR LIB -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
/* =====================================================
   RDFS ‚Äì ENTRY & DEPARTURE QR LOGIC (SCOPED)
===================================================== */

const rdfsQrEdSuccessBeep =
  new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const rdfsQrEdErrorBeep =
  new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

let rdfsQrEdRecent = [];
let rdfsQrEdPaused = false;

/* FEEDBACK */
function rdfsQrEdShow(message,type="info"){
  const fb=document.getElementById("rdfsQrEdFeedback");
  const scope=document.querySelector(".rdfs-qr-ed-scope");

  fb.className="alert mt-3 text-center rdfs-qr-ed-feedback";
  fb.textContent=message;
  fb.classList.remove("d-none","alert-success","alert-danger","alert-warning","alert-info");

  if(type==="success") fb.classList.add("alert-success");
  else if(type==="danger") fb.classList.add("alert-danger");
  else fb.classList.add("alert-info");

  scope.classList.remove("rdfs-qr-ed-flash-success","rdfs-qr-ed-flash-error");

  if(type==="success"){
    scope.classList.add("rdfs-qr-ed-flash-success");
    rdfsQrEdSuccessBeep.play().catch(()=>{});
  }else if(type==="danger"){
    scope.classList.add("rdfs-qr-ed-flash-error");
    rdfsQrEdErrorBeep.play().catch(()=>{});
  }
}

/* POST QR */
async function rdfsQrEdPost(qr){
  try{
    const res=await fetch("{% url 'terminal:qr_scan_entry' %}",{
      method:"POST",
      headers:{
        "X-CSRFToken":document.querySelector('[name=csrfmiddlewaretoken]').value,
        "X-Requested-With":"XMLHttpRequest"
      },
      body:new URLSearchParams({qr_code:qr})
    });

    const data=await res.json();
    const bal=data.balance!==undefined
      ? ` (Remaining Balance: ‚Ç±${parseFloat(data.balance).toFixed(2)})`
      : "";

    const msg=data.message+bal;

    if(data.status==="success"){
      rdfsQrEdShow(msg,"success");
      rdfsQrEdLog("‚úÖ Success",msg,"success");
      rdfsQrEdPause(4000);
    }else{
      rdfsQrEdShow(msg,"danger");
      rdfsQrEdLog("‚ùå Failed",msg,"danger");
      rdfsQrEdPause(3000);
    }
  }catch{
    rdfsQrEdShow("‚ö†Ô∏è Network error ‚Äî please check connection.","danger");
    rdfsQrEdLog("‚ö†Ô∏è Error","Network failure","danger");
  }
}

/* PAUSE */
function rdfsQrEdPause(ms){
  rdfsQrEdPaused=true;
  setTimeout(()=>{
    rdfsQrEdPaused=false;
    rdfsQrEdShow("üì∑ Ready for next scan...","info");
  },ms);
}

/* LOG */
function rdfsQrEdLog(status,message,type){
  const time=new Date().toLocaleTimeString();
  if(rdfsQrEdRecent.length>=5) rdfsQrEdRecent.shift();
  rdfsQrEdRecent.push({status,message,time,type});
  rdfsQrEdRender();
}

/* RENDER LOG */
function rdfsQrEdRender(){
  const el=document.getElementById("rdfsQrEdLog");
  el.innerHTML=`
    <table class="table table-sm table-hover align-middle mt-3 mb-0">
      <thead class="table-light">
        <tr><th>Time</th><th>Status</th><th>Message</th></tr>
      </thead>
      <tbody>
        ${rdfsQrEdRecent.map(s=>`
          <tr class="${s.type==="success"?"table-success":"table-danger"}">
            <td>${s.time}</td>
            <td>${s.status}</td>
            <td>${s.message}</td>
          </tr>
        `).reverse().join("")}
      </tbody>
    </table>
  `;
}

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  const qr=new Html5Qrcode("rdfsQrEdReader");
  let last="";

  qr.start(
    {facingMode:"environment"},
    {fps:10,qrbox:{width:250,height:250}},
    text=>{
      if(rdfsQrEdPaused||text===last) return;
      last=text;
      rdfsQrEdPost(text);
    },
    ()=>{}
  ).catch(err=>{
    rdfsQrEdShow("‚ùå Camera access failed: "+err,"danger");
  });
});
</script>

{% endblock %}
