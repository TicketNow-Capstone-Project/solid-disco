{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Terminal TV Display | RDFS</title>

  <link rel="icon" type="image/png" href="{% static 'img/RDFS-Logo.png' %}">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
  /* =====================================================
     RDFS – TERMINAL TV DISPLAY
  ===================================================== */
  :root{
    --rdfs-blue:#112666;
    --rdfs-blue-dark:#0c1c4a;
    --rdfs-accent:#2563eb;
    --rdfs-soft:#e8f4fd;

    --text:#0f172a;
    --muted:#64748b;

    --gray-100:#f7fafc;
    --gray-200:#edf2f7;
    --gray-300:#e2e8f0;

    --danger:#dc3545;
    --warning:#f59e0b;
    --success:#198754;

    --shadow-sm:0 1px 3px rgba(0,0,0,.08);
    --shadow-md:0 8px 18px rgba(0,0,0,.12);
  }

  body{
    background:linear-gradient(180deg,#ffffff 0%,#eef4ff 100%);
    font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
    font-size:1.35rem;
    color:var(--text);
    overflow-x:hidden;
  }

  /* HEADER */
  .tv-header{
    background:linear-gradient(135deg,var(--rdfs-blue),var(--rdfs-accent));
    color:#fff;
    padding:1.5rem 2rem;
    box-shadow:var(--shadow-md);
    text-align:center;
    position:relative;
    border-bottom:4px solid rgba(255,255,255,.1);
  }

  .tv-header h2{
    font-weight:800;
    font-size:2.2rem;
    margin-bottom:.25rem;
    letter-spacing:-0.5px;
  }

  .tv-sub{
    font-size:1.2rem;
    color:#e8f4fd;
    font-weight:500;
  }

  .tv-clock{
    font-size:1.2rem;
    font-weight:600;
    background:rgba(255,255,255,.15);
    padding:.4rem 1rem;
    border-radius:12px;
    display:inline-block;
    margin-top:.5rem;
    font-family:'JetBrains Mono',monospace;
  }

  /* HEADER BUTTONS */
  .tv-btn{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    padding:.6rem 1.5rem;
    font-size:1rem;
    font-weight:700;
    border-radius:12px;
    border:2px solid rgba(255,255,255,.3);
    background:rgba(255,255,255,.15);
    color:#fff;
    box-shadow:var(--shadow-sm);
    transition:.3s ease;
    text-decoration:none;
    backdrop-filter:blur(10px);
  }
  .tv-btn:hover{
    background:rgba(255,255,255,.25);
    border-color:rgba(255,255,255,.5);
    transform:translateY(-50%) scale(1.05);
  }
  .tv-btn.back{ left:25px; }
  .tv-btn.full{ right:25px; }

  /* CONTAINER HEADER */
  .container-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin:1.5rem 0 .5rem;
    padding:1rem;
    background:#fff;
    border-radius:16px;
    box-shadow:var(--shadow-sm);
  }

  .container-title{
    font-weight:800;
    font-size:1.6rem;
    color:var(--rdfs-blue-dark);
  }

  /* ROUTE FILTER (INSIDE CONTAINER) */
  .route-filter{
    display:flex;
    align-items:center;
    gap:.75rem;
    background:var(--gray-100);
    padding:.5rem 1rem;
    border-radius:12px;
  }

  .route-filter label{
    font-size:.95rem;
    font-weight:600;
    color:var(--rdfs-blue);
    white-space:nowrap;
  }

  .route-filter select{
    width:280px;
    height:48px;
    font-size:1rem;
    border-radius:12px;
    border:2px solid var(--rdfs-accent);
    padding:0 1.25rem;
    font-weight:600;
    background:#fff;
    color:var(--rdfs-blue);
    transition:.2s ease;
  }
  .route-filter select:focus{
    border-color:var(--rdfs-blue);
    box-shadow:0 0 0 3px rgba(37,99,235,.2);
    outline:none;
  }

  /* ROUTE SECTION */
  .route-section{
    border-radius:18px;
    padding:1.5rem;
    margin-bottom:2rem;
    box-shadow:var(--shadow-md);
    border:1px solid var(--gray-200);
    background:#fff;
    transition:transform .3s ease;
  }
  .route-section:hover{
    transform:translateY(-4px);
  }

  .route-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:1.6rem;
    font-weight:800;
    padding:1rem 1.5rem;
    border-radius:14px;
    margin-bottom:1.5rem;
    color:var(--rdfs-blue);
    border-left:6px solid var(--rdfs-accent);
  }

  .route-count{
    font-size:1rem;
    font-weight:600;
    color:#fff;
    background:var(--rdfs-accent);
    padding:.4rem 1rem;
    border-radius:20px;
    display:flex;
    align-items:center;
    gap:.5rem;
  }

  /* TABLE */
  table{
    background:#fff;
    border-radius:16px;
    overflow:hidden;
    font-size:1.3rem;
    border:none;
  }

  thead th{
    background:linear-gradient(135deg,var(--rdfs-blue),var(--rdfs-accent));
    color:#fff;
    text-align:center;
    font-size:1.15rem;
    padding:1rem;
    border:none;
    font-weight:600;
    letter-spacing:.5px;
  }
  thead th i{
    margin-right:.5rem;
    font-size:1.2em;
  }

  tbody td{
    text-align:center;
    vertical-align:middle;
    padding:1.25rem;
    font-weight:500;
    border-color:var(--gray-200);
  }

  tbody tr{
    transition:background .2s ease;
  }
  tbody tr:hover{
    background:var(--rdfs-soft);
  }

  /* VEHICLE INFO STYLING */
  .vehicle-plate{
    font-family:'JetBrains Mono',monospace;
    font-weight:700;
    font-size:1.4rem;
    color:var(--rdfs-blue);
    background:var(--gray-100);
    padding:.5rem 1rem;
    border-radius:10px;
    display:inline-block;
  }

  .driver-info{
    font-size:1.2rem;
    color:var(--text);
  }

  .entry-time{
    font-family:'JetBrains Mono',monospace;
    font-weight:500;
    color:var(--muted);
    background:var(--gray-100);
    padding:.4rem .8rem;
    border-radius:8px;
    display:inline-block;
  }

  /* COUNTDOWN CONTAINER */
  .countdown-container{
    min-width:320px;
  }

  .departure-info{
    font-size:.9rem;
    color:var(--muted);
    margin-top:.5rem;
    font-family:'JetBrains Mono',monospace;
    display:block;
  }

  /* STATUS BADGE IMPROVEMENTS */
  .status-badge{
    font-size:1.1rem;
    padding:.5rem 1rem;
    border-radius:12px;
    font-weight:700;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.5rem;
    min-width:200px;
    transition:all .3s ease;
  }

  .status-badge i{
    font-size:1.2em;
  }

  /* PROGRESS BAR IMPROVEMENTS */
  .progress-container{
    margin-top:1rem;
  }

  .progress{
    height:12px;
    border-radius:8px;
    background:var(--gray-200);
    overflow:hidden;
    box-shadow:inset 0 2px 4px rgba(0,0,0,.1);
  }

  .progress-bar{
    transition:width 1s linear, background .3s ease;
    border-radius:8px;
    position:relative;
  }

  .progress-bar::after{
    content:'';
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:linear-gradient(90deg,
      transparent 0%,
      rgba(255,255,255,.3) 50%,
      transparent 100%);
    animation:shimmer 2s infinite;
  }

  @keyframes shimmer{
    0%{transform:translateX(-100%);}
    100%{transform:translateX(100%);}
  }

  .progress-bar.glow{
    box-shadow:0 0 15px 5px rgba(220,53,69,.7);
    animation:pulse 2s infinite;
  }

  @keyframes pulse{
    0%,100%{box-shadow:0 0 15px 5px rgba(220,53,69,.7);}
    50%{box-shadow:0 0 20px 8px rgba(220,53,69,.9);}
  }

  /* COUNTDOWN TIMER SPECIFIC STYLES */
  .countdown-timer{
    font-family:'JetBrains Mono',monospace;
    font-size:1.3rem;
    font-weight:700;
    letter-spacing:1px;
  }

  .countdown-departed{
    animation:departureAlert 1.5s ease-in-out infinite;
  }

  @keyframes departureAlert{
    0%,100%{transform:scale(1);}
    50%{transform:scale(1.05);}
  }

  /* ALERT STYLING */
  .alert{
    font-size:1.4rem;
    border-radius:16px;
    padding:1.5rem;
    border:none;
    box-shadow:var(--shadow-sm);
  }

  /* RESPONSIVE ADJUSTMENTS */
  @media (max-width:1200px){
    body{font-size:1.2rem;}
    .tv-header h2{font-size:1.8rem;}
    .route-header{font-size:1.4rem;}
    .status-badge{min-width:180px;}
  }

  @media (max-width:768px){
    .tv-btn{position:relative;top:0;transform:none;margin:.5rem;}
    .tv-header{padding:1rem;}
    .container-header{flex-direction:column;gap:1rem;}
    .route-filter{width:100%;}
    .route-filter select{width:100%;}
    .route-section{padding:1rem;}
  }
  </style>
</head>

<body>

<!-- HEADER -->
<div class="tv-header">
  <h2><i class="bi bi-display-fill me-2"></i> Terminal Queue Board</h2>

  <div class="tv-sub">
    {% if selected_route != "All Routes" %}
      <i class="bi bi-signpost-split-fill me-1"></i> {{ selected_route }} Display
    {% else %}
      <i class="bi bi-globe-americas me-1"></i> All Routes Display
    {% endif %}
  </div>

  <div id="live-clock" class="tv-clock">
    <i class="bi bi-clock-history me-2"></i>
    <span id="current-date"></span> | <span id="current-time"></span>
  </div>

  <a href="{% url 'accounts:staff_dashboard' %}" class="tv-btn back">
    <i class="bi bi-arrow-left-circle-fill me-1"></i> Dashboard
  </a>

  <button id="fullscreenBtn" class="tv-btn full">
    <i class="bi bi-arrows-fullscreen me-1"></i> Fullscreen
  </button>
</div>

<!-- ROUTE CONTAINER -->
<div class="container-fluid px-5">

  <!-- CONTAINER HEADER -->
  <div class="container-header">
    <div class="container-title">
      <i class="bi bi-diagram-3-fill me-2"></i>
      Active Routes Overview
    </div>

    <div class="route-filter">
      <label for="routeSelector">
        <i class="bi bi-funnel-fill me-1"></i> Filter Route
      </label>
      <select id="routeSelector" onchange="filterRoute(this.value)">
        <option value="">All Routes</option>
        {% for route in all_routes %}
          <option value="{{ route.name|slugify }}"
                  {% if route.name == selected_route %}selected{% endif %}>
            <i class="bi bi-signpost me-1"></i> {{ route.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- ROUTES -->
  <div id="route-container">
    {% if grouped_routes %}
      {% for route_name, vehicles in grouped_routes.items %}
      <div class="route-section" data-route="{{ route_name|slugify }}">
        <div class="route-header">
          <div>
            <i class="bi bi-geo-alt-fill me-2"></i>
            {{ route_name }}
          </div>
          <div class="route-count">
            <i class="bi bi-truck"></i>
            {{ vehicles|length }} Active
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th><i class="bi bi-hash"></i> #</th>
                <th><i class="bi bi-truck-front-fill"></i> Vehicle</th>
                <th><i class="bi bi-person-circle"></i> Driver</th>
                <th><i class="bi bi-door-open-fill"></i> Entry Time</th>
                <th><i class="bi bi-clock-fill"></i> Departure Status</th>
              </tr>
            </thead>
            <tbody>
              {% for v in vehicles %}
              <tr>
                <td><strong>{{ forloop.counter }}</strong></td>
                <td>
                  <span class="vehicle-plate">
                    <i class="bi bi-tag-fill me-1"></i>{{ v.plate }}
                  </span>
                </td>
                <td class="driver-info">
                  <i class="bi bi-person-badge me-1"></i>
                  {{ v.driver }}
                </td>
                <td>
                  <span class="entry-time">
                    <i class="bi bi-calendar-check me-1"></i>
                    {{ v.entry_time }}
                  </span>
                </td>
                <td>
                  <div class="countdown-container">
                    <span class="status-badge countdown"
                          data-departure="{{ v.departure_time|date:'c' }}"
                          data-departure-formatted="{{ v.departure_time|date:'M d, Y H:i:s' }}">
                      <i class="bi bi-clock-history"></i>
                      <span class="countdown-text">Loading…</span>
                    </span>
                    <small class="departure-info">
                      <i class="bi bi-calendar-event me-1"></i>
                      Departs: <span class="departure-full-date"></span>
                    </small>
                    <div class="progress-container">
                      <div class="progress">
                        <div class="progress-bar"></div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-secondary text-center fs-4">
        <i class="bi bi-info-circle-fill me-2"></i> No active vehicles in terminal.
      </div>
    {% endif %}
  </div>
</div>

<script>
/* IMPROVED CLOCK WITH FULL DATE */
function updateDateTime() {
  const now = new Date();
  
  // Full date formatting
  const dateOptions = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  };
  const timeOptions = { 
    hour12: true, 
    hour: 'numeric', 
    minute: '2-digit', 
    second: '2-digit',
    timeZoneName: 'short' 
  };
  
  document.getElementById('current-date').textContent = 
    now.toLocaleDateString('en-US', dateOptions);
  document.getElementById('current-time').textContent = 
    now.toLocaleTimeString('en-US', timeOptions);
}

/* ROUTE FILTER */
function filterRoute(slug){
  const base = window.location.origin + "{% url 'terminal:tv_display' %}";
  window.location.href = slug ? base + slug + "/" : base;
}

/* ENHANCED ROUTE COLORS */
function applyRouteColors(){
  document.querySelectorAll(".route-section").forEach(section => {
    const routeName = section.dataset.route || "default";
    let hash = 0;
    for(let i = 0; i < routeName.length; i++){
      hash = routeName.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const hue = Math.abs(hash % 360);
    const saturation = 75;
    const lightness = 92;
    
    // Apply gradient background
    section.style.background = `
      linear-gradient(135deg, 
        hsl(${hue}, ${saturation}%, ${lightness}%) 0%,
        hsl(${hue}, ${saturation}%, ${lightness - 5}%) 100%
      )
    `;
    
    // Apply header background
    section.querySelector(".route-header").style.background = `
      linear-gradient(135deg, 
        hsl(${hue}, ${saturation}%, ${lightness - 20}%) 0%,
        hsl(${hue}, ${saturation}%, ${lightness - 30}%) 100%
      )
    `;
    
    // Apply border color
    section.style.borderColor = `hsl(${hue}, ${saturation}%, ${lightness - 10}%)`;
  });
}

/* ENHANCED COUNTDOWN WITH FULL DATE DISPLAY */
function updateCountdowns(){
  const now = Date.now();
  const departureLimit = 15 * 60 * 1000; // 15 minutes in milliseconds
  
  document.querySelectorAll(".countdown").forEach(countdownElement => {
    const departureTime = new Date(countdownElement.dataset.departure).getTime();
    const departureFormatted = countdownElement.dataset.departureFormatted;
    const timeDiff = departureTime - now;
    const progressBar = countdownElement.parentElement.querySelector(".progress-bar");
    const departureDateElement = countdownElement.parentElement.querySelector(".departure-full-date");
    const countdownText = countdownElement.querySelector(".countdown-text");
    
    // Always show full departure date
    if (departureDateElement) {
      departureDateElement.textContent = departureFormatted;
    }
    
    if (timeDiff <= 0) {
      // DEPARTED
      countdownText.textContent = "DEPARTED";
      countdownElement.className = "status-badge bg-danger text-white countdown-departed";
      countdownElement.innerHTML = '<i class="bi bi-check-circle-fill"></i> <span class="countdown-text">DEPARTED</span>';
      
      progressBar.style.width = "100%";
      progressBar.style.background = "#dc3545";
      progressBar.classList.add("glow");
      
    } else if (timeDiff <= departureLimit) {
      // COUNTDOWN ACTIVE (≤ 15 minutes)
      const minutes = Math.floor(timeDiff / 60000);
      const seconds = Math.floor((timeDiff % 60000) / 1000);
      
      // Format with leading zeros
      const minsStr = minutes.toString().padStart(2, '0');
      const secsStr = seconds.toString().padStart(2, '0');
      
      countdownText.textContent = `${minsStr}:${secsStr}`;
      countdownElement.className = "status-badge bg-warning text-dark countdown-timer";
      countdownElement.innerHTML = `<i class="bi bi-hourglass-split"></i> <span class="countdown-text">${minsStr}:${secsStr}</span>`;
      
      // Calculate progress percentage
      const progressPercent = 100 - (timeDiff / departureLimit) * 100;
      progressBar.style.width = `${progressPercent}%`;
      
      // Color coding based on time remaining
      if (progressPercent > 80) {
        progressBar.style.background = "#dc3545"; // Red - Very urgent
      } else if (progressPercent > 50) {
        progressBar.style.background = "#f59e0b"; // Orange - Urgent
      } else {
        progressBar.style.background = "#3b82f6"; // Blue - Warning
      }
      progressBar.classList.remove("glow");
      
    } else {
      // BOARDING (more than 15 minutes)
      countdownText.textContent = "BOARDING";
      countdownElement.className = "status-badge bg-success text-white";
      countdownElement.innerHTML = '<i class="bi bi-people-fill"></i> <span class="countdown-text">BOARDING</span>';
      
      progressBar.style.width = "0%";
      progressBar.classList.remove("glow");
    }
  });
}

/* AUTO REFRESH WITH VISUAL FEEDBACK */
let refreshInProgress = false;

function refreshContent() {
  if (refreshInProgress) return;
  
  refreshInProgress = true;
  
  // Add visual feedback
  const routeContainer = document.getElementById('route-container');
  routeContainer.style.opacity = '0.7';
  routeContainer.style.transition = 'opacity 0.3s ease';
  
  fetch(location.href, {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.text())
  .then(html => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const newContent = doc.getElementById('route-container').innerHTML;
    
    routeContainer.innerHTML = newContent;
    routeContainer.style.opacity = '1';
    
    // Reinitialize
    applyRouteColors();
    updateCountdowns();
    refreshInProgress = false;
  })
  .catch(error => {
    console.error('Refresh failed:', error);
    routeContainer.style.opacity = '1';
    refreshInProgress = false;
  });
}

/* FULLSCREEN WITH IMPROVED FEEDBACK */
const fullscreenBtn = document.getElementById('fullscreenBtn');
fullscreenBtn.onclick = () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen-exit me-1"></i> Exit Fullscreen';
    fullscreenBtn.classList.add('btn-danger');
    fullscreenBtn.classList.remove('btn-light');
  } else {
    document.exitFullscreen();
    fullscreenBtn.innerHTML = '<i class="bi bi-arrows-fullscreen me-1"></i> Fullscreen';
    fullscreenBtn.classList.remove('btn-danger');
    fullscreenBtn.classList.add('btn-light');
  }
};

// Handle fullscreen change events
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    fullscreenBtn.innerHTML = '<i class="bi bi-arrows-fullscreen me-1"></i> Fullscreen';
    fullscreenBtn.classList.remove('btn-danger');
  }
});

/* INITIALIZE */
document.addEventListener('DOMContentLoaded', () => {
  updateDateTime();
  setInterval(updateDateTime, 1000);
  
  applyRouteColors();
  updateCountdowns();
  setInterval(updateCountdowns, 1000); // Update every second for countdown
  
  // Auto-refresh every 30 seconds
  setInterval(refreshContent, 30000);
  
  // Add fade-in animation
  document.body.style.opacity = '0';
  document.body.style.transition = 'opacity 0.5s ease';
  setTimeout(() => {
    document.body.style.opacity = '1';
  }, 100);
});
</script>

</body>
</html>