{% extends 'base.html' %}
{% load static %}
{% block title %}Deposit Menu | TicketNow{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 bg-light sidebar p-3">
            {% include 'includes/sidebar.html' %}
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 p-4">
            <h2><i class="bi bi-wallet2"></i> Deposit Menu</h2>
            <p class="text-muted">
                Record deposits for drivers to update their wallet balances before terminal entry.
            </p>

            <!-- ðŸŸ© Info Alert for Minimum Deposit -->
            <div class="alert alert-info d-flex align-items-center">
                <i class="bi bi-info-circle me-2"></i>
                <div>Minimum deposit required before entry: <strong>â‚±{{ min_deposit }}</strong></div>
            </div>

            <!-- âœ… Deposit Form -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-body">
                    <form id="depositForm" method="POST">
                        {% csrf_token %}
                        <div class="row g-3 align-items-end">
                            <!-- ðŸŸ© Searchable Driver Dropdown -->
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Select Driver</label>
                                <select id="driverSelect" name="driver" class="form-select" required>
                                    <option value="">-- Select a Driver --</option>
                                    {% for driver in drivers %}
                                        <option value="{{ driver.id }}">
                                            {{ driver.first_name }} {{ driver.last_name }} ({{ driver.license_number }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label fw-bold">Current Balance</label>
                                <input type="text" id="walletBalance" class="form-control" value="â‚±0.00" readonly>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Deposit Amount</label>
                                <input type="number" name="amount" step="0.01" min="1" class="form-control" placeholder="â‚± Amount" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-warning mt-3 w-100">
                            <i class="bi bi-cash-coin"></i> Record Deposit
                        </button>
                    </form>

                    <!-- ðŸŸ© Feedback Message -->
                    <div id="depositFeedback" class="alert mt-3 d-none" role="alert"></div>
                </div>
            </div>

            <!-- âœ… Recent Deposits Table -->
            <div class="mt-4 card shadow-sm">
                <div class="card-header bg-light fw-bold">
                    <i class="bi bi-clock-history"></i> Recent Deposits
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Driver</th>
                                    <th>Vehicle</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dep in recent_deposits %}
                                <tr>
                                    <td>{{ dep.wallet.vehicle.assigned_driver.first_name }} {{ dep.wallet.vehicle.assigned_driver.last_name }}</td>
                                    <td>{{ dep.wallet.vehicle.license_plate }}</td>
                                    <td>â‚±{{ dep.amount }}</td>
                                    <td>{{ dep.get_payment_method_display }}</td>
                                    <td>{{ dep.status|title }}</td>
                                    <td>{{ dep.created_at|date:"M d, Y H:i" }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="6" class="text-center text-muted">No deposits yet.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- âœ… Flash Messages -->
            {% if messages %}
            <div class="mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- âœ… Script Section -->
<script>
function getCSRFToken() {
    const el = document.querySelector('#depositForm [name=csrfmiddlewaretoken]');
    return el ? el.value : '';
}

document.addEventListener('DOMContentLoaded', function() {
    const driverSelect = document.getElementById('driverSelect');
    const balanceDisplay = document.getElementById('walletBalance');
    const feedback = document.getElementById('depositFeedback');

    // ðŸŸ© Update wallet balance dynamically
    driverSelect.addEventListener('change', async function() {
        const driverId = this.value;
        if (!driverId) {
            balanceDisplay.value = 'â‚±0.00';
            return;
        }
        try {
            const res = await fetch(`{% url 'vehicles:get_wallet_balance' 0 %}`.replace('0', driverId));
            const data = await res.json();
            if (data.success) {
                balanceDisplay.value = `â‚±${parseFloat(data.balance).toFixed(2)}`;
            } else {
                balanceDisplay.value = 'â‚±0.00';
            }
        } catch {
            balanceDisplay.value = 'â‚±0.00';
        }
    });

    // ðŸŸ¨ Handle deposit via AJAX
    const depositForm = document.getElementById('depositForm');
    depositForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(depositForm);
        const res = await fetch("{% url 'vehicles:ajax_deposit' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            body: formData
        });
        const data = await res.json();

        feedback.classList.remove('d-none', 'alert-success', 'alert-danger');
        if (data.success) {
            feedback.classList.add('alert-success');
            feedback.textContent = data.message || 'Deposit successful!';
            depositForm.reset();
            balanceDisplay.value = `â‚±${parseFloat(data.new_balance).toFixed(2)}`;
            setTimeout(() => location.reload(), 1500);
        } else {
            feedback.classList.add('alert-danger');
            feedback.textContent = data.message || 'Deposit failed. Please check inputs.';
        }
    });
});
</script>
{% endblock %}
