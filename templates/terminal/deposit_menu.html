{% extends 'base.html' %}
{% load static %}
{% block title %}Deposit Menu | TicketNow{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 sidebar">
      {% include 'includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="fw-bold text-primary"><i class="bi bi-wallet2 me-2"></i> Deposit Menu</h3>
        <span class="text-muted">Minimum required before entry: <strong>₱{{ min_deposit }}</strong></span>
      </div>

      <!-- Alerts -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      {% if user.role == 'admin' %}
      <!-- ======================== ADMIN VIEW ======================== -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white fw-semibold">
          <i class="bi bi-clock-history me-2"></i> Deposit History
        </div>
        <div class="card-body">
          <form method="get" class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label">Start Date</label>
              <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">End Date</label>
              <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-funnel"></i> Apply Filter
              </button>
            </div>
          </form>

          <div class="table-responsive">
            <table id="depositTable" class="table table-striped table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Reference</th>
                  <th>Driver</th>
                  <th>Vehicle</th>
                  <th>Amount</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {% for deposit in recent_deposits %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td><strong>{{ deposit.reference_number }}</strong></td>
                    <td>{{ deposit.wallet.vehicle.assigned_driver.last_name }}, {{ deposit.wallet.vehicle.assigned_driver.first_name }}</td>
                    <td>{{ deposit.wallet.vehicle.license_plate }}</td>
                    <td>₱{{ deposit.amount|floatformat:2 }}</td>
                    <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="6" class="text-center text-muted">No deposits found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {% else %}
      <!-- ======================== STAFF VIEW ======================== -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-success text-white fw-semibold">
          <i class="bi bi-plus-circle"></i> Add Deposit
        </div>
        <div class="card-body">
          <form method="POST" onsubmit="showLoader()">
            {% csrf_token %}
            <div class="row g-3">
              <div class="col-md-5">
                <label class="form-label fw-semibold">Select Vehicle</label>
                <select id="vehicleSelect" name="vehicle_id" class="form-select" required>
                  <option value="">-- Choose Vehicle --</option>
                  {% for driver in drivers %}
                    {% for vehicle in driver.vehicles.all %}
                      <option value="{{ vehicle.id }}">{{ vehicle.license_plate }} — {{ driver.last_name }}, {{ driver.first_name }}</option>
                    {% endfor %}
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Deposit Amount (₱)</label>
                <input type="number" name="amount" min="1" step="0.01" class="form-control" required placeholder="Enter amount">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100"><i class="bi bi-cash-stack"></i> Add Deposit</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header bg-light fw-bold">
          <i class="bi bi-clock-history"></i> Recent Deposits
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table id="depositTable" class="table table-striped align-middle">
              <thead class="table-primary">
                <tr>
                  <th>#</th>
                  <th>Reference</th>
                  <th>Driver</th>
                  <th>Vehicle</th>
                  <th>Amount</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {% if recent_deposits %}
                  {% for deposit in recent_deposits %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td><strong>{{ deposit.reference_number }}</strong></td>
                      <td>{{ deposit.wallet.vehicle.assigned_driver.last_name }}, {{ deposit.wallet.vehicle.assigned_driver.first_name }}</td>
                      <td>{{ deposit.wallet.vehicle.license_plate }}</td>
                      <td>₱{{ deposit.amount|floatformat:2 }}</td>
                      <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="6" class="text-center text-muted">No deposits yet.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  $('#vehicleSelect').select2({ placeholder: "Search vehicle...", width: '100%' });
  $('#depositTable').DataTable({
    pageLength: 5,
    lengthMenu: [5, 10, 25, 50],
    order: [[5, 'desc']],
    language: { search: "_INPUT_", searchPlaceholder: "Search deposits..." }
  });
});
</script>
{% endblock %}
