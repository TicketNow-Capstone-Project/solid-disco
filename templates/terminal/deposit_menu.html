{% extends "base.html" %}
{% load static %}

{% block title %}Deposit Menu | RDFS{% endblock %}

{% block content %}

<style>
/* =====================================================
   RDFS ‚Äì DEPOSIT MENU (STRICTLY SCOPED)
   Prefix: rdfs-deposit-
===================================================== */
.rdfs-deposit-scope{
  --shadow-md:0 8px 20px rgba(0,0,0,0.04);
  --muted:#6c757d;
}

/* CONTAINER */
.rdfs-deposit-container{
  max-width:1250px;
  margin:auto;
}

/* TITLES */
.rdfs-deposit-title{
  font-weight:700;
}

.rdfs-deposit-note{
  font-size:.95rem;
  color:var(--muted);
}

/* CARDS */
.rdfs-deposit-card{
  border-radius:12px;
  box-shadow:var(--shadow-md);
}

/* TABLE */
.rdfs-deposit-table thead th{
  background-color:#f1f3f5;
}

/* BADGES */
.rdfs-deposit-today{
  font-size:.95rem;
}

/* SPINNER */
@keyframes rdfsDepositSpin{
  from{transform:rotate(0deg);}
  to{transform:rotate(360deg);}
}
.rdfs-deposit-spin{
  animation:rdfsDepositSpin 1s linear infinite;
}
</style>

<div class="p-4 rdfs-deposit-scope rdfs-deposit-container">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="text-primary rdfs-deposit-title">
      <i class="bi bi-wallet-fill me-2"></i>
      Deposit Menu
    </h3>
    <span class="rdfs-deposit-note">
      Minimum required before entry:
      <strong>‚Ç±{{ min_deposit }}</strong>
    </span>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  {% if role == 'admin' %}
  <!-- ================= ADMIN VIEW ================= -->
  <div class="card border-0 mb-4 rdfs-deposit-card">
    <div class="card-header bg-primary text-white fw-semibold d-flex justify-content-between align-items-center">
      <div>
        <i class="bi bi-clock-fill me-2"></i>
        Deposit History
      </div>
      <span class="badge bg-light text-dark rdfs-deposit-today">
        Showing: {{ start_date }}{% if end_date %} ‚Äî {{ end_date }}{% endif %}
      </span>
    </div>

    <div class="card-body">

      <!-- FILTER -->
      <form method="get" class="row g-3 mb-4">
        <div class="col-md-4">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-funnel-fill me-1"></i>
            Apply Filter
          </button>
        </div>
      </form>

      <!-- TABLE -->
      <div class="table-responsive">
        <table id="rdfsDepositTable"
               class="table table-striped table-hover align-middle rdfs-deposit-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Reference</th>
              <th>Driver</th>
              <th>Vehicle</th>
              <th>Amount</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for deposit in deposits %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td><strong>{{ deposit.reference_number }}</strong></td>
              <td>{{ deposit.wallet.vehicle.assigned_driver.last_name }},
                  {{ deposit.wallet.vehicle.assigned_driver.first_name }}</td>
              <td>{{ deposit.wallet.vehicle.license_plate }}</td>
              <td>‚Ç±{{ deposit.amount|floatformat:2 }}</td>
              <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                No deposits found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>

  {% else %}
  <!-- ================= STAFF VIEW ================= -->
  <div class="card border-0 mb-4 rdfs-deposit-card">
    <div class="card-header bg-success text-white fw-semibold">
      <i class="bi bi-plus-circle-fill me-1"></i>
      Add Deposit
    </div>

    <div class="card-body">
      <form method="POST" action="{% url 'terminal:deposit_menu' %}">
        {% csrf_token %}
        <div class="row g-3">

          <div class="col-md-5">
            <label class="form-label fw-semibold">Select Vehicle</label>
            <select id="rdfsVehicleSelect"
                    name="vehicle_id"
                    class="form-select"
                    required>
              <option value="">-- Choose Vehicle --</option>
              {% for driver in drivers %}
                {% for vehicle in driver.vehicles.all %}
                  <option value="{{ vehicle.id }}">
                    {{ vehicle.license_plate }} ‚Äî {{ driver.last_name }},
                    {{ driver.first_name }}
                  </option>
                {% endfor %}
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">
              Deposit Amount (‚Ç±)
            </label>
            <input type="number"
                   name="amount"
                   min="1"
                   step="0.01"
                   class="form-control"
                   required
                   placeholder="Enter amount">
          </div>

          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-cash-coin me-1"></i>
              Add Deposit
            </button>
          </div>

        </div>
      </form>

      <div id="rdfsWalletInfo"
           class="mt-2 text-muted small fw-semibold"></div>
    </div>
  </div>

  <div class="card border-0 rdfs-deposit-card">
    <div class="card-header bg-light fw-bold">
      <i class="bi bi-clock-fill me-1"></i>
      Recent Deposits (Today)
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle rdfs-deposit-table">
          <thead class="table-primary">
            <tr>
              <th>#</th>
              <th>Reference</th>
              <th>Driver</th>
              <th>Vehicle</th>
              <th>Amount</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for deposit in recent_deposits %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td><strong>{{ deposit.reference_number }}</strong></td>
              <td>{{ deposit.wallet.vehicle.assigned_driver.last_name }},
                  {{ deposit.wallet.vehicle.assigned_driver.first_name }}</td>
              <td>{{ deposit.wallet.vehicle.license_plate }}</td>
              <td>‚Ç±{{ deposit.amount|floatformat:2 }}</td>
              <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                No deposits yet.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- BACK -->
  <div class="mt-4 text-end">
    <a href="{% url 'accounts:staff_dashboard' %}"
       class="btn btn-secondary btn-lg">
      <i class="bi bi-arrow-left-circle-fill me-1"></i>
      Back to Dashboard
    </a>
  </div>

</div>

<!-- DATATABLES -->
<link rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded",function(){

  /* DATATABLE */
  if ($('#rdfsDepositTable').length && $.fn.DataTable) {
    $('#rdfsDepositTable').DataTable({
      pageLength:5,
      lengthMenu:[5,10,25,50],
      order:[[5,'desc']],
      language:{
        search:"_INPUT_",
        searchPlaceholder:"Search deposits..."
      }
    });
  }

  /* WALLET BALANCE */
  if ($('#rdfsVehicleSelect').length) {
    $('#rdfsVehicleSelect').on('change',function(){
      const vehicleId=$(this).val();
      const info=$('#rdfsWalletInfo');

      if(!vehicleId){
        info.html('');
        return;
      }

      info.html(
        '<i class="bi bi-arrow-repeat rdfs-deposit-spin me-1"></i> Checking balance...'
      );

      $.get("{% url 'terminal:ajax_get_wallet_balance' %}",{vehicle_id:vehicleId})
        .done(function(res){
          if(res.success){
            info.html(
              `üí∞ Current Balance for <strong>${res.vehicle}</strong>: ‚Ç±${res.balance.toFixed(2)}`
            );
          }else{
            info.html(`<span class="text-danger">‚ö†Ô∏è ${res.message}</span>`);
          }
        });
    });
  }

});
</script>

{% endblock %}
