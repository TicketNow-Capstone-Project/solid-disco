{% extends 'base.html' %}
{% load static %}
{% block title %}Deposit Menu | TicketNow{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 bg-light sidebar p-3">
      {% include 'includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 p-4">
      <h2><i class="bi bi-wallet2"></i> Deposit Menu</h2>
      <p class="text-muted">Record cash deposits for drivers to update their wallet balances before terminal entry.</p>

      <!-- Minimum Deposit Info -->
      <div class="alert alert-info d-flex align-items-center">
        <i class="bi bi-info-circle me-2"></i>
        <div>Minimum deposit required before entry: <strong>₱{{ min_deposit }}</strong></div>
      </div>

      <!-- Flash Messages -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Deposit Form -->
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-body">
          <form method="POST">
            {% csrf_token %}
            <div class="row g-3 align-items-end">
              <!-- Driver Dropdown -->
              <div class="col-md-4">
                <label class="form-label fw-bold">Select Driver</label>
                <select id="driverSelect" name="driver_id" class="form-select" required>
                  <option value="">-- Choose Driver --</option>
                  {% for driver in drivers %}
                    <option value="{{ driver.id }}">{{ driver.last_name }}, {{ driver.first_name }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Vehicle Dropdown -->
              <div class="col-md-4">
                <label class="form-label fw-bold">Select Vehicle</label>
                <select id="vehicleSelect" name="vehicle_id" class="form-select" required disabled>
                  <option value="">-- Select Driver First --</option>
                </select>
              </div>

              <!-- Amount Input -->
              <div class="col-md-3">
                <label class="form-label fw-bold">Deposit Amount (₱)</label>
                <input type="number" name="amount" min="1" step="0.01" class="form-control" required placeholder="Enter amount">
              </div>

              <div class="col-md-1 text-end">
                <button type="submit" class="btn btn-success w-100">
                  <i class="bi bi-cash-stack"></i> Add
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Recent Deposits -->
      <div class="mt-4 card shadow-sm">
        <div class="card-header bg-light fw-bold">
          <i class="bi bi-clock-history"></i> Recent Deposits
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped align-middle table-sm">
              <thead class="table-primary">
                <tr>
                  <th>#</th>
                  <th>Reference</th>
                  <th>Driver</th>
                  <th>Vehicle</th>
                  <th>Amount</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {% if recent_deposits %}
                  {% for deposit in recent_deposits %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td><strong>{{ deposit.reference_number }}</strong></td>
                      <td>{{ deposit.wallet.vehicle.assigned_driver.last_name }}, {{ deposit.wallet.vehicle.assigned_driver.first_name }}</td>
                      <td>{{ deposit.wallet.vehicle.license_plate }}</td>
                      <td>₱{{ deposit.amount|floatformat:2 }}</td>
                      <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="6" class="text-center text-muted">No deposits yet.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Select2 CDN -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Make dropdowns searchable
  $('#driverSelect').select2({ placeholder: "Search driver...", width: '100%' });
  $('#vehicleSelect').select2({ placeholder: "Search vehicle...", width: '100%' });

  // Driver → Vehicle dynamic fetch
  const driverSelect = document.getElementById("driverSelect");
  const vehicleSelect = document.getElementById("vehicleSelect");

  driverSelect.addEventListener("change", async () => {
    const driverId = driverSelect.value;
    vehicleSelect.innerHTML = '<option>Loading...</option>';
    vehicleSelect.disabled = true;

    if (!driverId) {
      vehicleSelect.innerHTML = '<option value="">-- Select Driver First --</option>';
      vehicleSelect.disabled = true;
      return;
    }

    try {
      const response = await fetch(`/vehicles/get-by-driver/${driverId}/`);
      const data = await response.json();
      vehicleSelect.innerHTML = "";

      if (data.vehicles && data.vehicles.length > 0) {
        data.vehicles.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v.id;
          opt.textContent = `${v.license_plate} — ${v.vehicle_name}`;
          vehicleSelect.appendChild(opt);
        });
        vehicleSelect.disabled = false;
      } else {
        vehicleSelect.innerHTML = '<option value="">No vehicles found</option>';
      }
    } catch (err) {
      console.error("Error loading vehicles:", err);
      vehicleSelect.innerHTML = '<option value="">Error loading vehicles</option>';
    }
  });
});
</script>
{% endblock %}
