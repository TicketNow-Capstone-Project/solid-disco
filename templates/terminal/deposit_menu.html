{% extends "base.html" %}
{% load static %}

{% block title %}Deposit Menu | TicketNow{% endblock %}

{% block content %}
<div class="p-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="fw-bold text-primary"><i class="bi bi-wallet2 me-2"></i> Deposit Menu</h3>
    <span class="text-muted">Minimum required before entry: <strong>‚Ç±{{ min_deposit }}</strong></span>
  </div>

  <!-- Alerts -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  {% if user.role == 'admin' %}
  <!-- ======================== ADMIN VIEW ======================== -->
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white fw-semibold">
      <i class="bi bi-clock-history me-2"></i> Deposit History
    </div>
    <div class="card-body">
      <form method="get" class="row g-3 mb-4">
        <div class="col-md-4">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-funnel"></i> Apply Filter
          </button>
        </div>
      </form>

      <div class="table-responsive">
        <table id="depositTable" class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Reference</th>
              <th>Driver</th>
              <th>Vehicle</th>
              <th>Amount</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for deposit in recent_deposits %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td><strong>{{ deposit.reference_number }}</strong></td>
                <td>{{ deposit.wallet.vehicle.assigned_driver.last_name }}, {{ deposit.wallet.vehicle.assigned_driver.first_name }}</td>
                <td>{{ deposit.wallet.vehicle.license_plate }}</td>
                <td>‚Ç±{{ deposit.amount|floatformat:2 }}</td>
                <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center text-muted">No deposits found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% else %}
  <!-- ======================== STAFF VIEW ======================== -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-success text-white fw-semibold">
      <i class="bi bi-plus-circle"></i> Add Deposit
    </div>
    <div class="card-body">
      <form method="POST" hx-post="{% url 'terminal:deposit_menu' %}" hx-target="#main-content" hx-swap="innerHTML transition:true">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-5">
            <label class="form-label fw-semibold">Select Vehicle</label>
            <select id="vehicleSelect" name="vehicle_id" class="form-select" required>
              <option value="">-- Choose Vehicle --</option>
              {% for driver in drivers %}
                {% for vehicle in driver.vehicles.all %}
                  <option value="{{ vehicle.id }}">{{ vehicle.license_plate }} ‚Äî {{ driver.last_name }}, {{ driver.first_name }}</option>
                {% endfor %}
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Deposit Amount (‚Ç±)</label>
            <input type="number" name="amount" min="1" step="0.01" class="form-control" required placeholder="Enter amount">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-cash-stack"></i> Add Deposit
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-light fw-bold">
      <i class="bi bi-clock-history"></i> Recent Deposits
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table id="depositTable" class="table table-striped align-middle">
          <thead class="table-primary">
            <tr>
              <th>#</th>
              <th>Reference</th>
              <th>Driver</th>
              <th>Vehicle</th>
              <th>Amount</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% if recent_deposits %}
              {% for deposit in recent_deposits %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td><strong>{{ deposit.reference_number }}</strong></td>
                  <td>{{ deposit.wallet.vehicle.assigned_driver.last_name }}, {{ deposit.wallet.vehicle.assigned_driver.first_name }}</td>
                  <td>{{ deposit.wallet.vehicle.license_plate }}</td>
                  <td>‚Ç±{{ deposit.amount|floatformat:2 }}</td>
                  <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="6" class="text-center text-muted">No deposits yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Back Button -->
  <div class="mt-4 text-end">
    <a hx-get="{% url 'accounts:staff_dashboard' %}" 
       hx-target="#main-content"
       hx-swap="innerHTML transition:true"
       class="btn btn-secondary btn-lg">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>
</div>

<!-- Select2 + DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'js/select2.min.js' %}"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  if (window.$ && $.fn) {
    $('#vehicleSelect').select2({ placeholder: "Search vehicle...", width: '100%' });
    $('#depositTable').DataTable({
      pageLength: 5,
      lengthMenu: [5, 10, 25, 50],
      order: [[5, 'desc']],
      language: { search: "_INPUT_", searchPlaceholder: "Search deposits..." }
    });
  }

  // üü¢ Add a wallet balance display beside vehicle selector
  const balanceInfo = $('<div id="walletInfo" class="mt-2 text-muted small fw-semibold"></div>');
  $('#vehicleSelect').after(balanceInfo);

  // üîÅ Load wallet balance when vehicle is selected
  $('#vehicleSelect').on('change', function() {
    const vehicleId = $(this).val();
    if (!vehicleId) {
      $('#walletInfo').html('');
      return;
    }

    $('#walletInfo').html('<i class="bi bi-arrow-repeat spin"></i> Checking balance...');
    $.get("{% url 'terminal:ajax_get_wallet_balance' %}", { vehicle_id: vehicleId })
      .done(function(response) {
        if (response.success) {
          $('#walletInfo').html(`üí∞ Current Balance for <strong>${response.vehicle}</strong>: ‚Ç±<span id="walletBalance">${response.balance.toFixed(2)}</span>`);
        } else {
          $('#walletInfo').html(`<span class="text-danger">‚ö†Ô∏è ${response.message}</span>`);
        }
      })
      .fail(() => $('#walletInfo').html(`<span class="text-danger">‚ùå Failed to load balance.</span>`));
  });

  // üßæ AJAX Deposit submission
  $("form").on("submit", function(e) {
    e.preventDefault();
    const form = $(this);
    const formData = form.serialize();

    $.ajax({
      url: "{% url 'terminal:ajax_add_deposit' %}",
      method: "POST",
      data: formData,
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
      beforeSend: function() {
        form.find("button[type=submit]").prop("disabled", true).html("<i class='bi bi-arrow-repeat spin'></i> Processing...");
      },
      success: function(response) {
        if (response.success) {
          showToast(response.message, "success");

          // üü¢ Add new deposit row instantly
          const table = $("#depositTable").DataTable();
          table.row.add([
            table.rows().count() + 1,
            `<strong>${response.deposit.reference}</strong>`,
            response.deposit.driver,
            response.deposit.vehicle,
            `‚Ç±${response.deposit.amount.toFixed(2)}`,
            response.deposit.date
          ]).draw(false);

          // üü¢ Refresh wallet balance display
          const selectedVehicle = $('#vehicleSelect').val();
          if (selectedVehicle) {
            $.get("{% url 'terminal:ajax_get_wallet_balance' %}", { vehicle_id: selectedVehicle })
              .done(function(r) {
                if (r.success) {
                  $('#walletBalance').text(r.balance.toFixed(2));
                }
              });
          }

          form.trigger("reset");
          $('#vehicleSelect').val('').trigger('change');
        } else {
          showToast(response.message, "danger");
        }
      },
      error: function() {
        showToast("‚ùå Server error. Try again.", "danger");
      },
      complete: function() {
        form.find("button[type=submit]").prop("disabled", false).html("<i class='bi bi-cash-stack'></i> Add Deposit");
      }
    });
  });

  // ‚ú® Toast Notification
  $("body").append(`<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>`);
  function showToast(msg, type) {
    const toast = $(`
      <div class="toast align-items-center text-bg-${type} border-0 show mb-2" role="alert">
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `);
    $("#toastContainer").append(toast);
    setTimeout(() => toast.fadeOut(400, () => toast.remove()), 4000);
  }

  $("<style>@keyframes spin {from {transform: rotate(0deg);} to {transform: rotate(360deg);}}</style>").appendTo("head");
});
</script>


{% endblock %}
