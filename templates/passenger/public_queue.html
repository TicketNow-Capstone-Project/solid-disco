{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Passenger View | TicketNow</title>
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f7f9fc;
      font-family: 'Segoe UI', sans-serif;
    }
    .hero {
      background: linear-gradient(135deg, #0d6efd, #6610f2);
      color: white;
      padding: 2rem 1rem;
      border-radius: 0 0 1rem 1rem;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    .hero h3 { font-weight: 700; }
    .card { border-radius: 0.75rem; overflow: hidden; }
    .route-pill {
      background: #e7f1ff;
      color: #0d6efd;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 50rem;
      font-size: 0.85rem;
    }
    .refresh-note {
      font-size: 0.9rem;
      color: #6c757d;
      text-align: center;
    }
    .countdown {
      font-weight: 600;
      color: #dc3545;
      transition: color 0.3s ease;
    }
    .progress {
      height: 8px;
      border-radius: 10px;
      margin-top: 4px;
      background-color: #e9ecef;
      overflow: hidden;
    }
    .progress-bar {
      transition: width 10s linear, background-color 0.5s ease;
      will-change: width, background-color;
    }
    .progress-bar.glow {
      box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
    }
    @media (max-width: 768px) {
      table { display: none; }
      .vehicle-card { display: block; }
    }
    @media (min-width: 769px) {
      .vehicle-card { display: none; }
    }
  </style>
</head>
<body>

<!-- üü¶ Hero Header -->
<div class="hero mb-4">
  <h3 class="mb-2"><i class="bi bi-bus-front-fill"></i> Terminal Vehicle Schedule</h3>
  <p class="mb-0">Check live departures and available routes below.</p>
</div>

<div class="container pb-4">

  <!-- üüß Filter Section -->
  <form method="get" class="row g-3 justify-content-center mb-4">
    <div class="col-md-4 col-sm-8">
      <select name="route" class="form-select shadow-sm" onchange="this.form.submit()">
        <option value="all">All Routes</option>
        {% for route in routes %}
          <option value="{{ route.id }}" {% if route.id|stringformat:'s' == selected_route %}selected{% endif %}>
            {{ route.origin }} ‚Üí {{ route.destination }}
          </option>
        {% endfor %}
      </select>
    </div>
  </form>

  <!-- üü© Vehicle Table (Desktop View) -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body table-responsive">
      {% if queue_entries %}
      <table class="table align-middle table-hover mb-0">
        <thead class="table-primary">
          <tr>
            <th>#</th>
            <th>Vehicle</th>
            <th>Route</th>
            <th>Driver</th>
            <th>Status</th>
            <th>Departure</th>
            <th>Countdown</th>
          </tr>
        </thead>
        <tbody>
          {% for q in queue_entries %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td><strong>{{ q.vehicle.license_plate }}</strong></td>
            <td><span class="route-pill">{{ q.vehicle.route.origin }} ‚Üí {{ q.vehicle.route.destination }}</span></td>
            <td>{{ q.vehicle.assigned_driver.first_name }} {{ q.vehicle.assigned_driver.last_name }}</td>
            <td>
              {% if q.is_active %}
                <span class="badge bg-success">Boarding</span>
              {% else %}
                <span class="badge bg-secondary">Departed</span>
              {% endif %}
            </td>
            <td>
              {% if q.departed_at %}
                {{ q.departed_at|date:"M d, Y h:i A" }}
              {% else %}
                <em class="text-muted">Pending</em>
              {% endif %}
            </td>
            <td>
              {% if q.departed_at %}
                <span class="countdown" data-departure="{{ q.departed_at|date:'Y-m-d H:i:s' }}"></span>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: 0%;" data-departure="{{ q.departed_at|date:'Y-m-d H:i:s' }}"></div>
                </div>
              {% else %}
                <em class="text-muted">‚Äî</em>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="text-center text-muted my-3">No vehicles currently scheduled for departure.</p>
      {% endif %}
    </div>
  </div>

  <!-- üü® Mobile View Cards -->
  {% for q in queue_entries %}
  <div class="vehicle-card card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0"><i class="bi bi-truck"></i> {{ q.vehicle.license_plate }}</h5>
        {% if q.is_active %}
          <span class="badge bg-success">Boarding</span>
        {% else %}
          <span class="badge bg-secondary">Departed</span>
        {% endif %}
      </div>
      <p class="mb-1 text-muted small">
        <i class="bi bi-signpost-split"></i>
        {{ q.vehicle.route.origin }} ‚Üí {{ q.vehicle.route.destination }}
      </p>
      <p class="mb-1 text-muted small">
        <i class="bi bi-person-badge"></i>
        {{ q.vehicle.assigned_driver.first_name }} {{ q.vehicle.assigned_driver.last_name }}
      </p>
      <p class="mb-1 text-muted small">
        <i class="bi bi-clock"></i>
        {% if q.departed_at %}
          {{ q.departed_at|date:"M d, Y h:i A" }}
        {% else %}
          <em>Pending</em>
        {% endif %}
      </p>
      {% if q.departed_at %}
      <p class="mb-1 text-danger small">
        <i class="bi bi-hourglass-split"></i>
        <span class="countdown" data-departure="{{ q.departed_at|date:'Y-m-d H:i:s' }}"></span>
      </p>
      <div class="progress">
        <div class="progress-bar" role="progressbar" style="width: 0%;" data-departure="{{ q.departed_at|date:'Y-m-d H:i:s' }}"></div>
      </div>
      {% endif %}
    </div>
  </div>
  {% empty %}
  <p class="text-center text-muted">No vehicles currently scheduled.</p>
  {% endfor %}

  <p class="refresh-note mt-4">
    <i class="bi bi-arrow-repeat"></i> Auto-refreshing every <strong>15 seconds</strong> for live updates
  </p>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function updateCountdowns() {
  const now = new Date().getTime();
  const thirtyMin = 30 * 60 * 1000;

  document.querySelectorAll('.countdown').forEach(span => {
    const departureTime = new Date(span.dataset.departure).getTime();
    const diff = departureTime - now;
    const bar = span.parentElement.querySelector('.progress-bar');
    if (!bar) return;

    if (diff <= 0) {
      span.textContent = "üöê Departing now!";
      bar.style.width = "100%";
      bar.style.backgroundColor = "#dc3545";
      bar.classList.add('glow');
    } else if (diff <= thirtyMin) {
      const mins = Math.floor(diff / (1000 * 60));
      span.textContent = `‚è≥ Leaving in ${mins} min${mins !== 1 ? 's' : ''}`;
      const progress = 100 - (diff / thirtyMin) * 100;
      bar.style.width = progress + "%";
      if (progress < 50) bar.style.backgroundColor = "#0d6efd";
      else if (progress < 80) bar.style.backgroundColor = "#fd7e14";
      else {
        bar.style.backgroundColor = "#dc3545";
        bar.classList.add('glow');
      }
    } else {
      const mins = Math.floor((diff - thirtyMin) / (1000 * 60));
      span.textContent = `üïí Boarding soon (${mins} min later)`;
      bar.style.width = "0%";
      bar.style.backgroundColor = "#0d6efd";
      bar.classList.remove('glow');
    }
  });
}

// üåÄ Simple loading spinner overlay
function showSpinner() {
  if (!document.getElementById("loadingSpinner")) {
    $("body").append(`
      <div id="loadingSpinner" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.7); z-index: 9999; display: flex;
        justify-content: center; align-items: center; font-size: 1.2rem; color: #0d6efd;
        font-weight: 600; backdrop-filter: blur(2px);
      ">
        <div><i class='bi bi-arrow-repeat spin'></i> Updating schedule...</div>
      </div>
    `);
    $(".spin").css({
      "animation": "spin 1s linear infinite",
      "display": "inline-block"
    });
    $("<style>@keyframes spin {from {transform: rotate(0deg);} to {transform: rotate(360deg);}}</style>").appendTo("head");
  }
  $("#loadingSpinner").fadeIn(150);
}

function hideSpinner() {
  $("#loadingSpinner").fadeOut(300);
}

// üîÅ Smooth queue refresh (every 15s)
function refreshQueue() {
  showSpinner();
  $.get("/passenger/data/", function(response) {
    const tbody = $("table tbody");
    const mobileContainer = $(".vehicle-card").parent();
    tbody.empty();
    mobileContainer.find(".vehicle-card").remove();

    if (response.entries.length === 0) {
      tbody.append(`<tr><td colspan="7" class="text-center text-muted">No vehicles currently scheduled.</td></tr>`);
      mobileContainer.append(`<p class="text-center text-muted">No vehicles currently scheduled.</p>`);
      hideSpinner();
      return;
    }

    response.entries.forEach((item, index) => {
      const countdownHTML = `
        <span class="countdown" data-departure="${item.departure}"></span>
        <div class="progress"><div class="progress-bar" role="progressbar" style="width: 0%;" data-departure="${item.departure}"></div></div>
      `;
      const row = `
        <tr>
          <td>${index + 1}</td>
          <td><strong>${item.plate}</strong></td>
          <td><span class="route-pill">${item.route}</span></td>
          <td>${item.driver}</td>
          <td><span class="badge ${item.status === 'Boarding' ? 'bg-success' : 'bg-secondary'}">${item.status}</span></td>
          <td>${new Date(item.departure).toLocaleString()}</td>
          <td>${countdownHTML}</td>
        </tr>`;
      tbody.append(row);

      // Mobile Card
      const card = `
        <div class="vehicle-card card shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0"><i class="bi bi-truck"></i> ${item.plate}</h5>
              <span class="badge ${item.status === 'Boarding' ? 'bg-success' : 'bg-secondary'}">${item.status}</span>
            </div>
            <p class="mb-1 text-muted small"><i class="bi bi-signpost-split"></i> ${item.route}</p>
            <p class="mb-1 text-muted small"><i class="bi bi-person-badge"></i> ${item.driver}</p>
            <p class="mb-1 text-muted small"><i class="bi bi-clock"></i> ${new Date(item.departure).toLocaleString()}</p>
            <p class="mb-1 text-danger small"><i class="bi bi-hourglass-split"></i>
              <span class="countdown" data-departure="${item.departure}"></span>
            </p>
            <div class="progress"><div class="progress-bar" role="progressbar" style="width: 0%;" data-departure="${item.departure}"></div></div>
          </div>
        </div>`;
      mobileContainer.append(card);
    });

    // Refresh countdowns after updating DOM
    updateCountdowns();
    hideSpinner();
  });
}

// Initialize countdown loop + first refresh
updateCountdowns();
setInterval(updateCountdowns, 5000);
refreshQueue();
setInterval(refreshQueue, 15000);
</script>


</body>
</html>
